
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>petgem.solver.assembler &#8212; PETGEM 1.01 documentation</title>
    <link rel="stylesheet" href="../../../_static/petgem.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.01',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head>
  <body>
<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
  <a href="../../../index.html"><img style="vertical-align: middle" src="../../../_static/figures/petgem_logo.png" border="0" height="80px" alt="PETGEM"/></a>
    <a href="../../../index.html"><strong><font color="#355f7c"> Parallel Edge-based Tool for Geophysical Electromagnetic Modelling</font></strong></a>
  <a href="http://www.bsc.es/"><img src="../../../_static/figures/logo_bsc.jpeg" align="right" border="0" height="80px" alt="BSC"/></a>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Home</a>|&nbsp;</li>
        <li><a href="../../../WhatIs.html">What is PETGEM?</a>|&nbsp;</li>
        <li><a href="../../../Features.html">Features</a>|&nbsp;</li>
        <li><a href="../../../CSEMEdges.html">CSEM FM modelling</a>|&nbsp;</li>
        <li><a href="../../../Installation.html">Installation</a>|&nbsp;</li>
        <li><a href="../../../Tutorial.html">Tutorial</a>|&nbsp;</li>
        <li><a href="../../../Manual.html">Manual</a>|&nbsp;</li>
        <li><a href="../../../Publications.html">Publications</a>|&nbsp;</li>
	      <li><a href="../../../Download.html">Download</a>|&nbsp;</li>
        <li><a href="../../../Contact.html">Contact</a></li>

          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for petgem.solver.assembler</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># Author:  Octavio Castillo Reyes</span>
<span class="c1"># Contact: octavio.castillo@bsc.es</span>
<span class="sd">&#39;&#39;&#39; Define functions for assembly of sparse linear systems in Edge Finite</span>
<span class="sd">Element Method (EFEM) of lowest order in tetrahedral meshes.</span>
<span class="sd">&#39;&#39;&#39;</span>


<div class="viewcode-block" id="computeElementalContributionsMPI"><a class="viewcode-back" href="../../../petgem/solver/assembler.html#petgem.solver.assembler.computeElementalContributionsMPI">[docs]</a><span class="k">def</span> <span class="nf">computeElementalContributionsMPI</span><span class="p">(</span><span class="n">modelling</span><span class="p">,</span> <span class="n">coordEle</span><span class="p">,</span> <span class="n">nodesEle</span><span class="p">,</span> <span class="n">sigmaEle</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Compute the elemental contributions of matrix A (LHS) and right hand</span>
<span class="sd">    side (RHS) in a parallel-vectorized manner for CSEM surveys by EFEM. Here,</span>
<span class="sd">    all necessary arrays are populated (Distributed-memory approach).</span>

<span class="sd">    :param dictionary modelling: CSEM modelling with physical parameters.</span>
<span class="sd">    :param ndarray coordEle: array with nodal coordinates of element.</span>
<span class="sd">    :param ndarray nodesEle: array with nodal indexes of element.</span>
<span class="sd">    :param float sigmaEle: element conductiviy.</span>
<span class="sd">    :return: Ae, be.</span>
<span class="sd">    :rtype: complex.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># ----------- Read physical parameters -----------</span>
    <span class="n">FREQ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">modelling</span><span class="p">[</span><span class="s1">&#39;FREQ&#39;</span><span class="p">])</span>
    <span class="n">SIGMA_BGROUND</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">modelling</span><span class="p">[</span><span class="s1">&#39;CONDUCTIVITY_BACKGROUND&#39;</span><span class="p">])</span>
    <span class="n">SRC_POS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">modelling</span><span class="p">[</span><span class="s1">&#39;SRC_POS&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">SRC_DIREC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">modelling</span><span class="p">[</span><span class="s1">&#39;SRC_DIREC&#39;</span><span class="p">])</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">modelling</span><span class="p">[</span><span class="s1">&#39;SRC_CURRENT&#39;</span><span class="p">])</span>
    <span class="n">dS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">modelling</span><span class="p">[</span><span class="s1">&#39;SRC_LENGTH&#39;</span><span class="p">])</span>

    <span class="c1"># ----------- Edge order -----------</span>
    <span class="n">edgeOrder</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="c1"># ----------- Nodal order -----------</span>
    <span class="n">nodalOrder</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="c1"># ----------- Number of dimensions -----------</span>
    <span class="n">nDimensions</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="c1"># ----------- Definition of constants-----------</span>
    <span class="n">ZERO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">ONE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">TWO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
    <span class="n">THREE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="mf">3.0</span><span class="p">)</span>
    <span class="n">FOUR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="mf">4.0</span><span class="p">)</span>
    <span class="n">SIX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="mf">6.0</span><span class="p">)</span>
    <span class="c1"># Imaginary part for complex numbers</span>
    <span class="n">IMAG_PART</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">(</span><span class="mf">0.0</span> <span class="o">+</span> <span class="mf">1.0</span><span class="n">j</span><span class="p">)</span>
    <span class="c1"># Volume constants</span>
    <span class="n">CONST_VOL1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="mf">6.0</span><span class="p">)</span>
    <span class="n">CONST_VOL2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="mf">360.0</span><span class="p">)</span>
    <span class="n">CONST_VOL3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="mf">720.0</span><span class="p">)</span>
    <span class="c1"># Vacuum permeability</span>
    <span class="n">MU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">FOUR</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="mf">1.0e-7</span><span class="p">))</span>
    <span class="c1"># Angular frequency</span>
    <span class="n">OMEGA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">FREQ</span><span class="o">*</span><span class="n">TWO</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    <span class="c1"># Propagation parameter</span>
    <span class="n">WAVENUMBER</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">complex</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="o">-</span><span class="n">IMAG_PART</span><span class="o">*</span><span class="n">MU</span><span class="o">*</span><span class="n">OMEGA</span><span class="o">*</span><span class="n">SIGMA_BGROUND</span><span class="p">))</span>
    <span class="c1"># Physical constants</span>
    <span class="n">CONST_PHY1</span> <span class="o">=</span> <span class="n">I</span> <span class="o">*</span> <span class="n">dS</span>
    <span class="n">CONST_PHY2</span> <span class="o">=</span> <span class="n">FOUR</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">SIGMA_BGROUND</span>
    <span class="n">CONST_PHY3</span> <span class="o">=</span> <span class="o">-</span><span class="n">IMAG_PART</span> <span class="o">*</span> <span class="n">WAVENUMBER</span>
    <span class="n">CONST_PHY4</span> <span class="o">=</span> <span class="o">-</span><span class="n">WAVENUMBER</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">CONST_PHY5</span> <span class="o">=</span> <span class="n">THREE</span> <span class="o">*</span> <span class="n">IMAG_PART</span> <span class="o">*</span> <span class="n">WAVENUMBER</span>
    <span class="n">CONST_PHY6</span> <span class="o">=</span> <span class="n">IMAG_PART</span><span class="o">*</span><span class="n">OMEGA</span><span class="o">*</span><span class="n">MU</span>

    <span class="c1"># ----------- Gaussian points for the unit -----------</span>
    <span class="c1"># ------------ reference tetrahedron -----------------</span>
    <span class="n">polyOrder</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="p">[</span><span class="n">gaussP</span><span class="p">,</span> <span class="n">gaussW</span><span class="p">]</span> <span class="o">=</span> <span class="n">gauss_points_tetrahedron</span><span class="p">(</span><span class="n">polyOrder</span><span class="p">)</span>

    <span class="c1"># Number of Gaussian points</span>
    <span class="n">ngaussP</span> <span class="o">=</span> <span class="n">gaussP</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Normalization of gauss points</span>
    <span class="n">SUM_GAUSS_WEIGTHS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gaussW</span><span class="p">)</span>

    <span class="c1"># ----------- Edge definition for the tetrahedral elements -----------</span>
    <span class="c1"># ----- Table 8.2 of Jin&#39;s book. Here is consider as an 1D-array -----</span>
    <span class="n">edgesN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>

    <span class="c1"># ----------- Definition of arrays for vector operations -----------</span>
    <span class="c1"># Signs computation</span>
    <span class="n">idx_signs1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
    <span class="n">idx_signs2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>

    <span class="c1"># ----------- Allocate arrays for vector operations -----------</span>
    <span class="c1"># Lagrange coefficients</span>
    <span class="n">allocate</span> <span class="o">=</span> <span class="n">nodalOrder</span>
    <span class="n">a_coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">b_coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">c_coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">d_coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="c1"># Coordinates of evaluation points (primaty field)</span>
    <span class="n">allocate</span> <span class="o">=</span> <span class="n">nDimensions</span>
    <span class="n">X_Coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">Y_Coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">Z_Coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">allocate</span> <span class="o">=</span> <span class="n">ngaussP</span>
    <span class="n">pEvalX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">pEvalY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">pEvalZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="c1"># Nedelec basis functions</span>
    <span class="n">allocate</span> <span class="o">=</span> <span class="n">ngaussP</span><span class="o">*</span><span class="n">edgeOrder</span>
    <span class="n">temp_A1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">temp_A2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">temp_b1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">temp_b2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nDimensions</span><span class="p">,</span> <span class="n">allocate</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="c1"># Vector operations over edges</span>
    <span class="n">rep_edges1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">ngaussP</span><span class="p">)</span>
    <span class="n">rep_edges2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">edgeOrder</span><span class="p">)</span>
    <span class="n">rep_edges3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">edgeOrder</span><span class="p">)</span>
    <span class="c1"># Vector operations over gauss points</span>
    <span class="n">idxbx1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">ngaussP</span><span class="p">)</span>
    <span class="n">idxbx2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">ngaussP</span><span class="p">)</span>
    <span class="c1"># Mass matrix</span>
    <span class="n">allocate</span> <span class="o">=</span> <span class="n">edgeOrder</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">Me</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="c1"># Stiffness matrix</span>
    <span class="n">rep_edges_stiff1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">edgeOrder</span><span class="p">)</span>
    <span class="n">rep_edges_stiff2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">edgeOrder</span><span class="p">)</span>
    <span class="n">rep_edges_stiff3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                 <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                 <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                 <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                 <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
                                 <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
    <span class="n">rep_edges_stiff4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">edgeOrder</span><span class="p">)</span>
    <span class="c1"># Stiffness matrix</span>
    <span class="n">Ke</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="c1"># Auxiliar vectors</span>
    <span class="c1"># Elemental matrix</span>
    <span class="n">allocate</span> <span class="o">=</span> <span class="n">nodalOrder</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">f2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">f3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">f4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">allocate</span> <span class="o">=</span> <span class="n">edgeOrder</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">std_v1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">std_v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">std_v3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">std_v4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">std_v5</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">std_v6</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">std_v7</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">std_v8</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">std_v9</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">std_v10</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">std_v11</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">std_v12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">std_v13</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">std_v14</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">std_v15</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">std_v16</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">std_v17</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">std_v18</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">std_v19</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">std_v20</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">std_v21</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">std_v22</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">std_v23</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">std_v24</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">std_v25</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="c1"># Distance to source</span>
    <span class="n">allocate</span> <span class="o">=</span> <span class="n">ngaussP</span>
    <span class="n">distX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">distY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">distZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="c1"># Electric field</span>
    <span class="n">field</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nDimensions</span><span class="p">,</span> <span class="n">allocate</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span>
    <span class="n">indx_field</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ngaussP</span><span class="p">)),</span> <span class="n">edgeOrder</span><span class="p">)</span>
    <span class="n">allocate</span> <span class="o">=</span> <span class="n">edgeOrder</span><span class="o">*</span><span class="n">ngaussP</span>
    <span class="n">temp_field</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nDimensions</span><span class="p">,</span> <span class="n">allocate</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span>
    <span class="c1"># Elemental matrix and elemental vector</span>
    <span class="n">allocate</span> <span class="o">=</span> <span class="n">edgeOrder</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">Ae</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span>
    <span class="n">allocate</span> <span class="o">=</span> <span class="n">edgeOrder</span>
    <span class="n">be</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">allocate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span>
    <span class="c1"># Indexes within dimensions of gauss points and basis functions</span>
    <span class="n">idx_gaussP_1</span> <span class="o">=</span> <span class="n">ngaussP</span>
    <span class="n">idx_gaussP_2</span> <span class="o">=</span> <span class="n">ngaussP</span><span class="o">*</span><span class="mi">2</span>
    <span class="n">idx_gaussP_3</span> <span class="o">=</span> <span class="n">ngaussP</span><span class="o">*</span><span class="mi">3</span>
    <span class="n">idx_gaussP_4</span> <span class="o">=</span> <span class="n">ngaussP</span><span class="o">*</span><span class="mi">4</span>
    <span class="n">idx_gaussP_5</span> <span class="o">=</span> <span class="n">ngaussP</span><span class="o">*</span><span class="mi">5</span>

    <span class="c1"># ----------- Compute element&#39;s volume -----------</span>
    <span class="n">eleVol</span> <span class="o">=</span> <span class="p">(((</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">-</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span>
               <span class="p">(</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="o">-</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span>
               <span class="p">(</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">-</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">-</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span>
               <span class="p">(</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">-</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
               <span class="p">(</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">-</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">-</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span>
               <span class="p">(</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">-</span>
              <span class="p">((</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">-</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span>
               <span class="p">(</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">-</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
               <span class="p">(</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">-</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">-</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span>
               <span class="p">(</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="o">-</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span>
               <span class="p">(</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">-</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">-</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span>
               <span class="p">(</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span> <span class="o">*</span> <span class="n">CONST_VOL1</span>

    <span class="c1"># ----------- Compute edges&#39;s length of element -----------</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">coordEle</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">edgesN</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">lengthEle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">edges</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># ----------- Delta sigma of element -----------</span>
    <span class="n">deltaSigma</span> <span class="o">=</span> <span class="n">sigmaEle</span> <span class="o">-</span> <span class="n">SIGMA_BGROUND</span>

    <span class="c1"># ----------- Edge&#39;s signs -----------</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">nodesEle</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">idx_signs1</span><span class="p">]</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">[</span><span class="n">idx_signs2</span><span class="p">]</span>
    <span class="n">signsEle</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

    <span class="c1"># ----------- Compute Lagrange coefficients -----------</span>
    <span class="c1"># Constants</span>
    <span class="n">S1</span> <span class="o">=</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
    <span class="n">S2</span> <span class="o">=</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">S3</span> <span class="o">=</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
    <span class="n">S4</span> <span class="o">=</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
    <span class="n">S5</span> <span class="o">=</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">S6</span> <span class="o">=</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
    <span class="n">S7</span> <span class="o">=</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>
    <span class="n">S8</span> <span class="o">=</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">S9</span> <span class="o">=</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span>
    <span class="n">S10</span> <span class="o">=</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span>
    <span class="n">S11</span> <span class="o">=</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">S12</span> <span class="o">=</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">S13</span> <span class="o">=</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>
    <span class="n">S14</span> <span class="o">=</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">S15</span> <span class="o">=</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">S16</span> <span class="o">=</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
    <span class="c1"># Coefficients a</span>
    <span class="n">a_coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">S1</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">+</span> <span class="n">S2</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">+</span> <span class="n">S3</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span> <span class="o">-</span>
                  <span class="p">(</span><span class="n">S4</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="n">S5</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">+</span> <span class="n">S6</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="n">a_coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">S7</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">S8</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">+</span> <span class="n">S9</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span>
                  <span class="p">(</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">S6</span> <span class="o">+</span> <span class="n">S4</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">S10</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">6</span><span class="p">]))</span><span class="o">*-</span><span class="n">ONE</span>
    <span class="n">a_coeff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">S8</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="n">S11</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">+</span> <span class="n">S12</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span>
                  <span class="p">(</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">S10</span> <span class="o">+</span> <span class="n">S13</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="n">S14</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">9</span><span class="p">]))</span>
    <span class="n">a_coeff</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">S3</span> <span class="o">+</span> <span class="n">S1</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">S2</span> <span class="o">-</span>
                  <span class="p">(</span><span class="n">S5</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">S15</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">+</span>
                   <span class="n">S16</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">*-</span><span class="n">ONE</span>
    <span class="c1"># Coefficients b</span>
    <span class="n">b_coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">S9</span> <span class="o">+</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="n">S3</span><span class="p">)</span> <span class="o">-</span>
                  <span class="p">(</span><span class="n">S16</span> <span class="o">+</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">+</span> <span class="n">S6</span><span class="p">))</span><span class="o">*-</span><span class="n">ONE</span>
    <span class="n">b_coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">S12</span> <span class="o">+</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">+</span> <span class="n">S9</span> <span class="o">-</span>
                  <span class="p">(</span><span class="n">S6</span> <span class="o">+</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">S10</span><span class="p">))</span>
    <span class="n">b_coeff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">+</span>
                  <span class="n">S12</span> <span class="o">-</span> <span class="p">(</span><span class="n">S10</span> <span class="o">+</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="n">S14</span><span class="p">))</span><span class="o">*-</span><span class="n">ONE</span>
    <span class="n">b_coeff</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">S3</span> <span class="o">+</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">-</span>
                  <span class="p">(</span><span class="n">S14</span> <span class="o">+</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">+</span> <span class="n">S16</span><span class="p">))</span>
    <span class="c1"># Coefficients c</span>
    <span class="n">c_coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">+</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span>
                  <span class="n">coordEle</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">S2</span> <span class="o">+</span>
                                             <span class="n">coordEle</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">+</span>
                                             <span class="n">coordEle</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">8</span><span class="p">]))</span>
    <span class="n">c_coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span>
                  <span class="n">coordEle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">+</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">-</span>
                  <span class="p">(</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">+</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span>
                   <span class="n">coordEle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">11</span><span class="p">]))</span><span class="o">*-</span><span class="n">ONE</span>
    <span class="n">c_coeff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">+</span>
                  <span class="n">coordEle</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">+</span>
                                             <span class="n">coordEle</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span>
                                             <span class="n">coordEle</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">c_coeff</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">+</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span>
                  <span class="n">coordEle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span>
                                             <span class="n">coordEle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">+</span>
                                             <span class="n">S2</span><span class="p">))</span><span class="o">*-</span><span class="n">ONE</span>
    <span class="c1"># Coefficients d</span>
    <span class="n">d_coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">S7</span> <span class="o">+</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">S1</span> <span class="o">-</span>
                  <span class="p">(</span><span class="n">S5</span> <span class="o">+</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">+</span> <span class="n">S4</span><span class="p">))</span><span class="o">*-</span><span class="n">ONE</span>
    <span class="n">d_coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">S8</span> <span class="o">+</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="n">S7</span> <span class="o">-</span>
                  <span class="p">(</span><span class="n">S4</span> <span class="o">+</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">S13</span><span class="p">))</span>
    <span class="n">d_coeff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">S11</span> <span class="o">+</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">+</span> <span class="n">S8</span> <span class="o">-</span>
                  <span class="p">(</span><span class="n">S13</span> <span class="o">+</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">S15</span><span class="p">))</span><span class="o">*-</span><span class="n">ONE</span>
    <span class="n">d_coeff</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">S1</span> <span class="o">+</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">S11</span> <span class="o">-</span>
                  <span class="p">(</span><span class="n">S15</span> <span class="o">+</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="n">S5</span><span class="p">))</span>

    <span class="c1"># ----------- Map XiEtaZeta Gaussian points to real element -----------</span>
    <span class="c1"># Compute coefficients</span>
    <span class="n">X_Coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">X_Coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">-</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">X_Coeff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">-</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">Y_Coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">-</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Y_Coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">-</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Y_Coeff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">-</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Z_Coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">Z_Coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">-</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">Z_Coeff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="o">-</span><span class="n">coordEle</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="c1"># X-coordinates</span>
    <span class="n">pEvalX</span> <span class="o">=</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_Coeff</span><span class="o">*</span><span class="n">gaussP</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Y-coordinates</span>
    <span class="n">pEvalY</span> <span class="o">=</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_Coeff</span><span class="o">*</span><span class="n">gaussP</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Z-coordinates</span>
    <span class="n">pEvalZ</span> <span class="o">=</span> <span class="n">coordEle</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Z_Coeff</span><span class="o">*</span><span class="n">gaussP</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># ----------- Nedelec basis computation -----------</span>
    <span class="c1"># Reduce number of multiplications</span>
    <span class="n">A1</span> <span class="o">=</span> <span class="p">(</span><span class="n">a_coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">b_coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">pEvalX</span> <span class="o">+</span>
          <span class="n">c_coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">pEvalY</span> <span class="o">+</span> <span class="n">d_coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">pEvalZ</span><span class="p">)</span>
    <span class="n">A2</span> <span class="o">=</span> <span class="p">(</span><span class="n">a_coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">b_coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">pEvalX</span> <span class="o">+</span>
          <span class="n">c_coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">pEvalY</span> <span class="o">+</span> <span class="n">d_coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">pEvalZ</span><span class="p">)</span>
    <span class="n">A3</span> <span class="o">=</span> <span class="p">(</span><span class="n">a_coeff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">b_coeff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">pEvalX</span> <span class="o">+</span>
          <span class="n">c_coeff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">pEvalY</span> <span class="o">+</span> <span class="n">d_coeff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">pEvalZ</span><span class="p">)</span>
    <span class="n">A4</span> <span class="o">=</span> <span class="p">(</span><span class="n">a_coeff</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">b_coeff</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">pEvalX</span> <span class="o">+</span>
          <span class="n">c_coeff</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">pEvalY</span> <span class="o">+</span> <span class="n">d_coeff</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">pEvalZ</span><span class="p">)</span>
    <span class="c1"># Prepare data for vector multiplications</span>
    <span class="n">tmp_edges</span> <span class="o">=</span> <span class="n">lengthEle</span><span class="p">[</span><span class="n">rep_edges1</span><span class="p">]</span><span class="o">*</span><span class="p">((</span><span class="n">SIX</span><span class="o">*</span><span class="n">eleVol</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**-</span><span class="mi">1</span>
    <span class="c1"># First component of x-basis</span>
    <span class="n">temp_b1</span> <span class="o">=</span> <span class="n">b_coeff</span><span class="p">[</span><span class="n">idxbx1</span><span class="p">]</span>
    <span class="n">temp_A1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">idx_gaussP_1</span><span class="p">]</span> <span class="o">=</span> <span class="n">A1</span>
    <span class="n">temp_A1</span><span class="p">[</span><span class="n">idx_gaussP_1</span><span class="p">:</span><span class="n">idx_gaussP_2</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_A1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">idx_gaussP_1</span><span class="p">]</span>
    <span class="n">temp_A1</span><span class="p">[</span><span class="n">idx_gaussP_2</span><span class="p">:</span><span class="n">idx_gaussP_3</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_A1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">idx_gaussP_1</span><span class="p">]</span>
    <span class="n">temp_A1</span><span class="p">[</span><span class="n">idx_gaussP_3</span><span class="p">:</span><span class="n">idx_gaussP_4</span><span class="p">]</span> <span class="o">=</span> <span class="n">A2</span>
    <span class="n">temp_A1</span><span class="p">[</span><span class="n">idx_gaussP_4</span><span class="p">:</span><span class="n">idx_gaussP_5</span><span class="p">]</span> <span class="o">=</span> <span class="n">A4</span>
    <span class="n">temp_A1</span><span class="p">[</span><span class="n">idx_gaussP_5</span><span class="p">:]</span> <span class="o">=</span> <span class="n">A3</span>
    <span class="c1"># Second component of x_basis</span>
    <span class="n">temp_b2</span> <span class="o">=</span> <span class="n">b_coeff</span><span class="p">[</span><span class="n">idxbx2</span><span class="p">]</span>
    <span class="n">temp_A2</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">idx_gaussP_1</span><span class="p">]</span> <span class="o">=</span> <span class="n">A2</span>
    <span class="n">temp_A2</span><span class="p">[</span><span class="n">idx_gaussP_1</span><span class="p">:</span><span class="n">idx_gaussP_2</span><span class="p">]</span> <span class="o">=</span> <span class="n">A3</span>
    <span class="n">temp_A2</span><span class="p">[</span><span class="n">idx_gaussP_2</span><span class="p">:</span><span class="n">idx_gaussP_3</span><span class="p">]</span> <span class="o">=</span> <span class="n">A4</span>
    <span class="n">temp_A2</span><span class="p">[</span><span class="n">idx_gaussP_3</span><span class="p">:</span><span class="n">idx_gaussP_4</span><span class="p">]</span> <span class="o">=</span> <span class="n">A3</span>
    <span class="n">temp_A2</span><span class="p">[</span><span class="n">idx_gaussP_4</span><span class="p">:</span><span class="n">idx_gaussP_5</span><span class="p">]</span> <span class="o">=</span> <span class="n">A2</span>
    <span class="n">temp_A2</span><span class="p">[</span><span class="n">idx_gaussP_5</span><span class="p">:]</span> <span class="o">=</span> <span class="n">A4</span>
    <span class="c1"># X-component for all points and for all basis</span>
    <span class="n">basis</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp_b1</span><span class="o">*</span><span class="n">temp_A1</span> <span class="o">-</span> <span class="n">temp_b2</span><span class="o">*</span><span class="n">temp_A2</span><span class="p">)</span><span class="o">*</span><span class="n">tmp_edges</span>
    <span class="c1"># First component of y-basis</span>
    <span class="n">temp_b1</span> <span class="o">=</span> <span class="n">c_coeff</span><span class="p">[</span><span class="n">idxbx1</span><span class="p">]</span>
    <span class="c1"># Second component of y_basis</span>
    <span class="n">temp_b2</span> <span class="o">=</span> <span class="n">c_coeff</span><span class="p">[</span><span class="n">idxbx2</span><span class="p">]</span>
    <span class="c1"># Y-component for all points and for all basis</span>
    <span class="n">basis</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp_b1</span><span class="o">*</span><span class="n">temp_A1</span> <span class="o">-</span> <span class="n">temp_b2</span><span class="o">*</span><span class="n">temp_A2</span><span class="p">)</span><span class="o">*</span><span class="n">tmp_edges</span>
    <span class="c1"># First component of z-basis</span>
    <span class="n">temp_b1</span> <span class="o">=</span> <span class="n">d_coeff</span><span class="p">[</span><span class="n">idxbx1</span><span class="p">]</span>
    <span class="c1"># Second component of z_basis</span>
    <span class="n">temp_b2</span> <span class="o">=</span> <span class="n">d_coeff</span><span class="p">[</span><span class="n">idxbx2</span><span class="p">]</span>
    <span class="c1"># Y-component for all points and for all basis</span>
    <span class="n">basis</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp_b1</span><span class="o">*</span><span class="n">temp_A1</span> <span class="o">-</span> <span class="n">temp_b2</span><span class="o">*</span><span class="n">temp_A2</span><span class="p">)</span><span class="o">*</span><span class="n">tmp_edges</span>

    <span class="c1"># ----------- Computation of elemental matrix -----------</span>
    <span class="c1"># Compute mass matrix</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">b_coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">b_coeff</span> <span class="o">+</span> <span class="n">c_coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">c_coeff</span> <span class="o">+</span> <span class="n">d_coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">d_coeff</span>
    <span class="n">f2</span> <span class="o">=</span> <span class="n">b_coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">b_coeff</span> <span class="o">+</span> <span class="n">c_coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">c_coeff</span> <span class="o">+</span> <span class="n">d_coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">d_coeff</span>
    <span class="n">f3</span> <span class="o">=</span> <span class="n">b_coeff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">b_coeff</span> <span class="o">+</span> <span class="n">c_coeff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">c_coeff</span> <span class="o">+</span> <span class="n">d_coeff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">d_coeff</span>
    <span class="n">f4</span> <span class="o">=</span> <span class="n">b_coeff</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">b_coeff</span> <span class="o">+</span> <span class="n">c_coeff</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">c_coeff</span> <span class="o">+</span> <span class="n">d_coeff</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">d_coeff</span>
    <span class="n">AA1</span> <span class="o">=</span> <span class="p">(</span><span class="n">CONST_VOL2</span><span class="o">*</span><span class="n">eleVol</span><span class="p">)</span><span class="o">**-</span><span class="mi">1</span>
    <span class="n">AA2</span> <span class="o">=</span> <span class="p">(</span><span class="n">CONST_VOL3</span><span class="o">*</span><span class="n">eleVol</span><span class="p">)</span><span class="o">**-</span><span class="mi">1</span>
    <span class="c1"># Integral: Eq. 8.68. Upper triangular matrix</span>
    <span class="n">Me</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">lengthEle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">AA1</span> <span class="o">*</span> <span class="p">(</span><span class="n">f2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">f1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">f1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">Me</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lengthEle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">lengthEle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">AA2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">f2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">f1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span>
                                                 <span class="n">f1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">f1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">Me</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">lengthEle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">lengthEle</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">AA2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">f2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">f1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span>
                                                 <span class="n">f1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">f1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">Me</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">lengthEle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">lengthEle</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">AA2</span> <span class="o">*</span> <span class="p">(</span><span class="n">f2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">f2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span>
                                                 <span class="mi">2</span><span class="o">*</span><span class="n">f1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">f1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">Me</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">lengthEle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">lengthEle</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="n">AA2</span> <span class="o">*</span> <span class="p">(</span><span class="n">f2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">f2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span>
                                                 <span class="n">f1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">f1</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">Me</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">lengthEle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">lengthEle</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="n">AA2</span> <span class="o">*</span> <span class="p">(</span><span class="n">f2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">f2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span>
                                                 <span class="n">f1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">f1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">Me</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">lengthEle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">AA1</span> <span class="o">*</span> <span class="p">(</span><span class="n">f3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">f1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">f1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">Me</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">lengthEle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">lengthEle</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">AA2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">f3</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">f1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span>
                                                 <span class="n">f1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">f1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">Me</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">lengthEle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">lengthEle</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">AA2</span> <span class="o">*</span> <span class="p">(</span><span class="n">f3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">f2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span>
                                                 <span class="n">f1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">f1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">Me</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">lengthEle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">lengthEle</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="n">AA2</span> <span class="o">*</span> <span class="p">(</span><span class="n">f2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">f3</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span>
                                                  <span class="n">f1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">f1</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">Me</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">lengthEle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">lengthEle</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="n">AA2</span> <span class="o">*</span> <span class="p">(</span><span class="n">f1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">f3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span>
                                                  <span class="mi">2</span><span class="o">*</span><span class="n">f1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">f3</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">Me</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">lengthEle</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">AA1</span> <span class="o">*</span> <span class="p">(</span><span class="n">f4</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">f1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">f1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">Me</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">lengthEle</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">lengthEle</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">AA2</span> <span class="o">*</span> <span class="p">(</span><span class="n">f3</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">f2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span>
                                                  <span class="n">f1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">f1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">Me</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="n">lengthEle</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">lengthEle</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="n">AA2</span> <span class="o">*</span> <span class="p">(</span><span class="n">f2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">f4</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span>
                                                  <span class="mi">2</span><span class="o">*</span><span class="n">f1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">f1</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">Me</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="n">lengthEle</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">lengthEle</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="n">AA2</span> <span class="o">*</span> <span class="p">(</span><span class="n">f4</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">f3</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span>
                                                  <span class="n">f1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">f1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">Me</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="n">lengthEle</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">AA1</span> <span class="o">*</span> <span class="p">(</span><span class="n">f3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">f2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">f2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">Me</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">=</span> <span class="n">lengthEle</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">lengthEle</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="n">AA2</span> <span class="o">*</span> <span class="p">(</span><span class="n">f2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">f3</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span>
                                                  <span class="n">f2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">f2</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">Me</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="n">lengthEle</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">lengthEle</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="n">AA2</span> <span class="o">*</span> <span class="p">(</span><span class="n">f3</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">f3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span>
                                                  <span class="mi">2</span><span class="o">*</span><span class="n">f2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">f2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">Me</span><span class="p">[</span><span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="n">lengthEle</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">AA1</span> <span class="o">*</span> <span class="p">(</span><span class="n">f2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">f2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">f4</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">Me</span><span class="p">[</span><span class="mi">29</span><span class="p">]</span> <span class="o">=</span> <span class="n">lengthEle</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="n">lengthEle</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="n">AA2</span> <span class="o">*</span> <span class="p">(</span><span class="n">f2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">f2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span>
                                                  <span class="n">f4</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">f3</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">Me</span><span class="p">[</span><span class="mi">35</span><span class="p">]</span> <span class="o">=</span> <span class="n">lengthEle</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">AA1</span> <span class="o">*</span> <span class="p">(</span><span class="n">f4</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">f3</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">f3</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="c1"># Copy upper triangular matrix to lower triangular matrix</span>
    <span class="n">Me</span><span class="p">[[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span>
        <span class="mi">31</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">34</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Me</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>
                                           <span class="mi">11</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">29</span><span class="p">]]</span>
    <span class="c1"># Mass matrix</span>
    <span class="n">Me</span> <span class="o">=</span> <span class="n">Me</span><span class="o">*</span><span class="n">signsEle</span><span class="p">[</span><span class="n">rep_edges2</span><span class="p">]</span><span class="o">*</span><span class="n">signsEle</span><span class="p">[</span><span class="n">rep_edges3</span><span class="p">]</span>

    <span class="c1"># Compute stiffness matrix</span>
    <span class="n">std_v1</span> <span class="o">=</span> <span class="n">b_coeff</span><span class="p">[</span><span class="n">rep_edges_stiff1</span><span class="p">]</span>
    <span class="n">std_v2</span> <span class="o">=</span> <span class="n">b_coeff</span><span class="p">[</span><span class="n">rep_edges_stiff2</span><span class="p">]</span>
    <span class="n">std_v3</span> <span class="o">=</span> <span class="n">b_coeff</span><span class="p">[</span><span class="n">rep_edges_stiff3</span><span class="p">]</span>
    <span class="n">std_v4</span> <span class="o">=</span> <span class="n">b_coeff</span><span class="p">[</span><span class="n">rep_edges_stiff4</span><span class="p">]</span>
    <span class="n">std_v5</span> <span class="o">=</span> <span class="n">c_coeff</span><span class="p">[</span><span class="n">rep_edges_stiff1</span><span class="p">]</span>
    <span class="n">std_v6</span> <span class="o">=</span> <span class="n">c_coeff</span><span class="p">[</span><span class="n">rep_edges_stiff2</span><span class="p">]</span>
    <span class="n">std_v7</span> <span class="o">=</span> <span class="n">c_coeff</span><span class="p">[</span><span class="n">rep_edges_stiff3</span><span class="p">]</span>
    <span class="n">std_v8</span> <span class="o">=</span> <span class="n">c_coeff</span><span class="p">[</span><span class="n">rep_edges_stiff4</span><span class="p">]</span>
    <span class="n">std_v9</span> <span class="o">=</span> <span class="n">d_coeff</span><span class="p">[</span><span class="n">rep_edges_stiff1</span><span class="p">]</span>
    <span class="n">std_v10</span> <span class="o">=</span> <span class="n">d_coeff</span><span class="p">[</span><span class="n">rep_edges_stiff2</span><span class="p">]</span>
    <span class="n">std_v11</span> <span class="o">=</span> <span class="n">d_coeff</span><span class="p">[</span><span class="n">rep_edges_stiff3</span><span class="p">]</span>
    <span class="n">std_v12</span> <span class="o">=</span> <span class="n">d_coeff</span><span class="p">[</span><span class="n">rep_edges_stiff4</span><span class="p">]</span>
    <span class="n">std_v13</span> <span class="o">=</span> <span class="n">std_v5</span><span class="o">*</span><span class="n">std_v10</span>
    <span class="n">std_v14</span> <span class="o">=</span> <span class="n">std_v9</span><span class="o">*</span><span class="n">std_v6</span>
    <span class="n">std_v15</span> <span class="o">=</span> <span class="n">std_v7</span><span class="o">*</span><span class="n">std_v12</span>
    <span class="n">std_v16</span> <span class="o">=</span> <span class="n">std_v11</span><span class="o">*</span><span class="n">std_v8</span>
    <span class="n">std_v17</span> <span class="o">=</span> <span class="n">std_v9</span><span class="o">*</span><span class="n">std_v2</span>
    <span class="n">std_v18</span> <span class="o">=</span> <span class="n">std_v1</span><span class="o">*</span><span class="n">std_v10</span>
    <span class="n">std_v19</span> <span class="o">=</span> <span class="n">std_v11</span><span class="o">*</span><span class="n">std_v4</span>
    <span class="n">std_v20</span> <span class="o">=</span> <span class="n">std_v3</span><span class="o">*</span><span class="n">std_v12</span>
    <span class="n">std_v21</span> <span class="o">=</span> <span class="n">std_v1</span><span class="o">*</span><span class="n">std_v6</span>
    <span class="n">std_v22</span> <span class="o">=</span> <span class="n">std_v5</span><span class="o">*</span><span class="n">std_v2</span>
    <span class="n">std_v23</span> <span class="o">=</span> <span class="n">std_v3</span><span class="o">*</span><span class="n">std_v8</span>
    <span class="n">std_v24</span> <span class="o">=</span> <span class="n">std_v7</span><span class="o">*</span><span class="n">std_v4</span>
    <span class="n">std_v25</span> <span class="o">=</span> <span class="p">(</span><span class="n">lengthEle</span><span class="p">[</span><span class="n">rep_edges2</span><span class="p">]</span> <span class="o">*</span> <span class="n">lengthEle</span><span class="p">[</span><span class="n">rep_edges3</span><span class="p">]</span> <span class="o">*</span>
               <span class="n">signsEle</span><span class="p">[</span><span class="n">rep_edges2</span><span class="p">]</span> <span class="o">*</span> <span class="n">signsEle</span><span class="p">[</span><span class="n">rep_edges3</span><span class="p">])</span>

    <span class="c1"># Stiffness matrix</span>
    <span class="n">Ke</span> <span class="o">=</span> <span class="p">((</span><span class="n">std_v13</span> <span class="o">-</span> <span class="n">std_v14</span><span class="p">)</span> <span class="o">*</span>
          <span class="p">(</span><span class="n">std_v15</span> <span class="o">-</span> <span class="n">std_v16</span><span class="p">)</span> <span class="o">+</span>
          <span class="p">(</span><span class="n">std_v17</span> <span class="o">-</span> <span class="n">std_v18</span><span class="p">)</span> <span class="o">*</span>
          <span class="p">(</span><span class="n">std_v19</span> <span class="o">-</span> <span class="n">std_v20</span><span class="p">)</span> <span class="o">+</span>
          <span class="p">(</span><span class="n">std_v21</span> <span class="o">-</span> <span class="n">std_v22</span><span class="p">)</span> <span class="o">*</span>
          <span class="p">(</span><span class="n">std_v23</span> <span class="o">-</span> <span class="n">std_v24</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">FOUR</span><span class="o">*</span><span class="n">eleVol</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="n">SIX</span><span class="o">*</span><span class="n">eleVol</span><span class="p">)</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">std_v25</span>

    <span class="c1"># Compute elemental matrix</span>
    <span class="n">Ae</span> <span class="o">=</span> <span class="n">Ke</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">CONST_PHY6</span><span class="o">*</span><span class="n">sigmaEle</span><span class="p">,</span> <span class="n">Me</span><span class="p">)</span>

    <span class="c1"># ----------- Contributions for vector b -----------</span>
    <span class="c1"># Gaussian points weigths (normalization)</span>
    <span class="n">weightEle</span> <span class="o">=</span> <span class="n">gaussW</span> <span class="o">*</span> <span class="p">(</span><span class="n">eleVol</span> <span class="o">/</span> <span class="n">SUM_GAUSS_WEIGTHS</span><span class="p">)</span>

    <span class="c1"># Compute distance to the source for all Gaussian points</span>
    <span class="n">distX</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">pEvalX</span> <span class="o">-</span> <span class="n">SRC_POS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>     <span class="c1"># X-component</span>
    <span class="n">distY</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">pEvalY</span> <span class="o">-</span> <span class="n">SRC_POS</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>     <span class="c1"># Y-component</span>
    <span class="n">distZ</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">pEvalZ</span> <span class="o">-</span> <span class="n">SRC_POS</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>     <span class="c1"># Z-component</span>
    <span class="n">distance</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">distX</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">distY</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">distZ</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># To avoid very large or small numbers</span>
    <span class="n">distance</span><span class="p">[</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="n">ONE</span><span class="p">]</span> <span class="o">=</span> <span class="n">ONE</span>
    <span class="c1"># Compute the primary field for all Gaussian points</span>
    <span class="c1"># E = AA [ BB + (wavenumber^2*distance^2 -1i*wavenumber*distance-1)]</span>
    <span class="n">SQUARE_DISTANCE</span> <span class="o">=</span> <span class="n">distance</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">AA</span> <span class="o">=</span> <span class="n">CONST_PHY1</span> <span class="o">/</span> <span class="p">(</span><span class="n">CONST_PHY2</span> <span class="o">*</span> <span class="n">distance</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">CONST_PHY3</span> <span class="o">*</span>
                                                          <span class="n">distance</span><span class="p">)</span>
    <span class="n">BB</span> <span class="o">=</span> <span class="n">CONST_PHY4</span> <span class="o">*</span> <span class="n">SQUARE_DISTANCE</span> <span class="o">+</span> <span class="p">(</span><span class="n">CONST_PHY5</span> <span class="o">*</span> <span class="n">distance</span><span class="p">)</span> <span class="o">+</span> <span class="n">THREE</span>
    <span class="n">RR</span> <span class="o">=</span> <span class="n">ONE</span><span class="o">/</span><span class="n">SQUARE_DISTANCE</span>

    <span class="c1"># Compute primary field in function of source direction</span>
    <span class="k">if</span> <span class="n">SRC_DIREC</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># X-directed</span>
        <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">AA</span> <span class="o">*</span> <span class="p">((</span><span class="n">distX</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">RR</span><span class="p">)</span><span class="o">*</span><span class="n">BB</span> <span class="o">+</span>
                            <span class="p">(</span><span class="n">WAVENUMBER</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">SQUARE_DISTANCE</span> <span class="o">-</span> <span class="n">IMAG_PART</span> <span class="o">*</span>
                             <span class="n">WAVENUMBER</span> <span class="o">*</span> <span class="n">distance</span> <span class="o">-</span> <span class="n">ONE</span><span class="p">))</span>
        <span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">AA</span> <span class="o">*</span> <span class="p">(</span><span class="n">distX</span><span class="o">*</span><span class="n">distY</span><span class="o">*</span><span class="n">RR</span><span class="p">)</span><span class="o">*</span><span class="n">BB</span>
        <span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">AA</span> <span class="o">*</span> <span class="p">(</span><span class="n">distX</span><span class="o">*</span><span class="n">distZ</span><span class="o">*</span><span class="n">RR</span><span class="p">)</span><span class="o">*</span><span class="n">BB</span>
    <span class="k">elif</span> <span class="n">SRC_DIREC</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c1"># Y-directed</span>
        <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">AA</span> <span class="o">*</span> <span class="p">(</span><span class="n">distX</span><span class="o">*</span><span class="n">distY</span><span class="o">*</span><span class="n">RR</span><span class="p">)</span><span class="o">*</span><span class="n">BB</span>
        <span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">AA</span> <span class="o">*</span> <span class="p">((</span><span class="n">distY</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">RR</span><span class="p">)</span><span class="o">*</span><span class="n">BB</span> <span class="o">+</span>
                            <span class="p">(</span><span class="n">WAVENUMBER</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">SQUARE_DISTANCE</span> <span class="o">-</span> <span class="n">IMAG_PART</span> <span class="o">*</span>
                             <span class="n">WAVENUMBER</span> <span class="o">*</span> <span class="n">distance</span> <span class="o">-</span> <span class="n">ONE</span><span class="p">))</span>
        <span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">AA</span> <span class="o">*</span> <span class="p">(</span><span class="n">distY</span><span class="o">*</span><span class="n">distZ</span><span class="o">*</span><span class="n">RR</span><span class="p">)</span><span class="o">*</span><span class="n">BB</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Z-directed</span>
        <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">AA</span> <span class="o">*</span> <span class="p">(</span><span class="n">distX</span><span class="o">*</span><span class="n">distZ</span><span class="o">*</span><span class="n">RR</span><span class="p">)</span><span class="o">*</span><span class="n">BB</span>
        <span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">AA</span> <span class="o">*</span> <span class="p">(</span><span class="n">distZ</span><span class="o">*</span><span class="n">distY</span><span class="o">*</span><span class="n">RR</span><span class="p">)</span><span class="o">*</span><span class="n">BB</span>
        <span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">AA</span> <span class="o">*</span> <span class="p">((</span><span class="n">distZ</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">RR</span><span class="p">)</span><span class="o">*</span><span class="n">BB</span> <span class="o">+</span>
                            <span class="p">(</span><span class="n">WAVENUMBER</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">SQUARE_DISTANCE</span> <span class="o">-</span> <span class="n">IMAG_PART</span> <span class="o">*</span>
                             <span class="n">WAVENUMBER</span> <span class="o">*</span> <span class="n">distance</span> <span class="o">-</span> <span class="n">ONE</span><span class="p">))</span>

    <span class="c1"># Integral over edges</span>
    <span class="n">temp_field</span> <span class="o">=</span> <span class="n">field</span><span class="p">[:,</span> <span class="n">indx_field</span><span class="p">]</span>

    <span class="n">signsEle</span> <span class="o">=</span> <span class="n">signsEle</span><span class="p">[</span><span class="n">rep_edges1</span><span class="p">]</span>
    <span class="n">weightEle</span> <span class="o">=</span> <span class="n">weightEle</span><span class="p">[</span><span class="n">indx_field</span><span class="p">]</span>

    <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">temp_field</span><span class="o">*</span><span class="n">basis</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">signsEle</span> <span class="o">*</span> <span class="n">weightEle</span> <span class="o">*</span> <span class="n">deltaSigma</span>

    <span class="c1"># Integral over edges</span>
    <span class="k">for</span> <span class="n">iBasis</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">edgeOrder</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">iPoint</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ngaussP</span><span class="p">):</span>
            <span class="n">be</span><span class="p">[</span><span class="n">iBasis</span><span class="p">]</span> <span class="o">=</span> <span class="n">be</span><span class="p">[</span><span class="n">iBasis</span><span class="p">]</span> <span class="o">+</span> <span class="n">temp</span><span class="p">[(</span><span class="n">iBasis</span><span class="o">*</span><span class="n">ngaussP</span><span class="p">)</span><span class="o">+</span><span class="n">iPoint</span><span class="p">]</span>

    <span class="c1"># Scale vector by constant -1i*OMEGA*MU</span>
    <span class="n">be</span> <span class="o">=</span> <span class="n">be</span><span class="o">*-</span><span class="n">CONST_PHY6</span>

    <span class="k">return</span> <span class="n">Ae</span><span class="p">,</span> <span class="n">be</span></div>


<div class="viewcode-block" id="unitary_test"><a class="viewcode-back" href="../../../petgem/solver/assembler.html#petgem.solver.assembler.unitary_test">[docs]</a><span class="k">def</span> <span class="nf">unitary_test</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39; Unitary test for assembler.py script.</span>
<span class="sd">    &#39;&#39;&#39;</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># Standard module import</span>
    <span class="n">unitary_test</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># Standard module import</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">petsc4py</span>
    <span class="kn">from</span> <span class="nn">petsc4py</span> <span class="k">import</span> <span class="n">PETSc</span>
    <span class="c1"># PETGEM module import</span>
    <span class="kn">from</span> <span class="nn">petgem.efem.fem</span> <span class="k">import</span> <span class="n">gauss_points_tetrahedron</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Home</a>|&nbsp;</li>
        <li><a href="../../../WhatIs.html">What is PETGEM?</a>|&nbsp;</li>
        <li><a href="../../../Features.html">Features</a>|&nbsp;</li>
        <li><a href="../../../CSEMEdges.html">CSEM FM modelling</a>|&nbsp;</li>
        <li><a href="../../../Installation.html">Installation</a>|&nbsp;</li>
        <li><a href="../../../Tutorial.html">Tutorial</a>|&nbsp;</li>
        <li><a href="../../../Manual.html">Manual</a>|&nbsp;</li>
        <li><a href="../../../Publications.html">Publications</a>|&nbsp;</li>
	      <li><a href="../../../Download.html">Download</a>|&nbsp;</li>
        <li><a href="../../../Contact.html">Contact</a></li>

          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Octavio Castillo Reyes.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.6.
    </div>
  </body>
</html>