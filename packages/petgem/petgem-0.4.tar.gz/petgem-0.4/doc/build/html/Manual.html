
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Manual &#8212; PETGEM 1.01 documentation</title>
    <link rel="stylesheet" href="_static/petgem.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.01',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="setup.py" href="setup/setup.html" />
    <link rel="prev" title="Tutorial" href="Tutorial.html" /> 
  </head>
  <body>
<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
  <a href="index.html"><img style="vertical-align: middle" src="_static/figures/petgem_logo.png" border="0" height="80px" alt="PETGEM"/></a>
    <a href="index.html"><strong><font color="#355f7c"> Parallel Edge-based Tool for Geophysical Electromagnetic Modelling</font></strong></a>
  <a href="http://www.bsc.es/"><img src="_static/figures/logo_bsc.jpeg" align="right" border="0" height="80px" alt="BSC"/></a>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="setup/setup.html" title="setup.py"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="Tutorial.html" title="Tutorial"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Home</a>|&nbsp;</li>
        <li><a href="WhatIs.html">What is PETGEM?</a>|&nbsp;</li>
        <li><a href="Features.html">Features</a>|&nbsp;</li>
        <li><a href="CSEMEdges.html">CSEM FM modelling</a>|&nbsp;</li>
        <li><a href="Installation.html">Installation</a>|&nbsp;</li>
        <li><a href="Tutorial.html">Tutorial</a>|&nbsp;</li>
        <li><a href="#">Manual</a>|&nbsp;</li>
        <li><a href="Publications.html">Publications</a>|&nbsp;</li>
	      <li><a href="Download.html">Download</a>|&nbsp;</li>
        <li><a href="Contact.html">Contact</a></li>
 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h4>Previous topic</h4>
  <p class="topless"><a href="Tutorial.html"
                        title="previous chapter">Tutorial</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="setup/setup.html"
                        title="next chapter">setup.py</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="manual">
<span id="id1"></span><h1>Manual<a class="headerlink" href="#manual" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title first">Table of contents</p>
<ul class="simple">
<li><a class="reference internal" href="#how-generate-documentation" id="id24">How generate documentation</a></li>
<li><a class="reference internal" href="#coding-style" id="id25">Coding style</a></li>
<li><a class="reference internal" href="#petgem-design" id="id26">PETGEM design</a><ul>
<li><a class="reference internal" href="#component-diagram" id="id27">Component diagram</a></li>
<li><a class="reference internal" href="#class-diagram" id="id28">Class diagram</a></li>
<li><a class="reference internal" href="#sequence-diagram" id="id29">Sequence diagram</a></li>
<li><a class="reference internal" href="#petgem-directory-structure" id="id30">PETGEM directory structure</a></li>
</ul>
</li>
<li><a class="reference internal" href="#pre-processing" id="id31">Pre-processing</a></li>
<li><a class="reference internal" href="#running-a-simulation" id="id32">Running a simulation</a></li>
<li><a class="reference internal" href="#mesh-formats" id="id33">Mesh formats</a></li>
<li><a class="reference internal" href="#available-solvers" id="id34">Available solvers</a></li>
<li><a class="reference internal" href="#simulations-in-parallel" id="id35">Simulations in parallel</a></li>
<li><a class="reference internal" href="#visualization-of-results" id="id36">Visualization of results</a></li>
<li><a class="reference internal" href="#examples" id="id37">Examples</a><ul>
<li><a class="reference internal" href="#example-1-pre-processing-data-for-petgem" id="id38">Example 1: Pre-processing data for PETGEM</a><ul>
<li><a class="reference internal" href="#model" id="id39">Model</a></li>
</ul>
</li>
<li><a class="reference internal" href="#example-2-canonical-model-of-an-off-shore-hydrocarbon-reservoir" id="id40">Example 2: Canonical model of an off-shore hydrocarbon reservoir</a><ul>
<li><a class="reference internal" href="#id9" id="id41">Model</a></li>
<li><a class="reference internal" href="#meshing" id="id42">Meshing</a></li>
<li><a class="reference internal" href="#petgem-pre-processing" id="id43">PETGEM pre-processing</a></li>
<li><a class="reference internal" href="#parameters-file-for-petgem" id="id44">Parameters file for PETGEM</a></li>
<li><a class="reference internal" href="#running-petgem" id="id45">Running PETGEM</a></li>
<li><a class="reference internal" href="#petgem-post-processing" id="id46">PETGEM post-processing</a></li>
</ul>
</li>
<li><a class="reference internal" href="#example-3-use-of-petsc-solvers" id="id47">Example 3: Use of PETSc solvers</a></li>
</ul>
</li>
<li><a class="reference internal" href="#code-documentation" id="id48">Code documentation</a><ul>
<li><a class="reference internal" href="#setup-install-scripts" id="id49">Setup &amp; install scripts</a></li>
<li><a class="reference internal" href="#kernel" id="id50">kernel</a></li>
<li><a class="reference internal" href="#base-scripts" id="id51">Base scripts</a></li>
<li><a class="reference internal" href="#id11" id="id52">Pre-processing</a></li>
<li><a class="reference internal" href="#mesh-scripts" id="id53">Mesh scripts</a></li>
<li><a class="reference internal" href="#efem-scripts" id="id54">EFEM scripts</a></li>
<li><a class="reference internal" href="#solver" id="id55">Solver</a></li>
<li><a class="reference internal" href="#parallel" id="id56">Parallel</a></li>
<li><a class="reference internal" href="#post-processing" id="id57">Post-processing</a></li>
<li><a class="reference internal" href="#monitoring" id="id58">Monitoring</a></li>
<li><a class="reference internal" href="#id12" id="id59">Examples</a></li>
</ul>
</li>
</ul>
</div>
<p>This manual provides reference documentation to PETGEM from a user’s and
developer’s perspective.</p>
<div class="section" id="how-generate-documentation">
<span id="id2"></span><h2><a class="toc-backref" href="#table-of-contents">How generate documentation</a><a class="headerlink" href="#how-generate-documentation" title="Permalink to this headline">¶</a></h2>
<p>PETGEM is documented in PDF and HTML format using <a class="reference external" href="http://www.sphinx-doc.org">Sphinx</a> and
<a class="reference external" href="https://www.latex-project.org/">LaTeX</a>. The documentation source
is in the <code class="docutils literal"><span class="pre">doc/</span></code> directory. The following steps summarize how to generate PETGEM documentation.</p>
<ul>
<li><p class="first">Move to the PETGEM doc directory:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> doc
</pre></div>
</div>
</li>
<li><p class="first">Generate the PETGEM documentation in HTML format by typing:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ make html
</pre></div>
</div>
</li>
<li><p class="first">Or, if you prefer the PDF format by typing:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ make latexpdf
</pre></div>
</div>
</li>
<li><p class="first">The previous steps will build the documentation in the <code class="docutils literal"><span class="pre">doc/build</span></code> directory. Alternatively, you can modify this path by editing the file <code class="docutils literal"><span class="pre">setup.cfg</span></code> and provide the required information below <code class="docutils literal"><span class="pre">[build_sphinx]</span></code> section:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">[</span>build_sphinx<span class="o">]</span>
source-dir <span class="o">=</span> doc/source
build-dir  <span class="o">=</span> usr/local/path-build
<span class="nv">all_files</span>  <span class="o">=</span> <span class="m">1</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="coding-style">
<span id="id3"></span><h2><a class="toc-backref" href="#table-of-contents">Coding style</a><a class="headerlink" href="#coding-style" title="Permalink to this headline">¶</a></h2>
<p>PETGEM’s coding style is based on
<a class="reference external" href="https://www.python.org/dev/peps/pep-0008/">PEP-0008</a> guidelines. Main
guidelines are the following:</p>
<ul>
<li><p class="first">79 characteres per line.</p>
</li>
<li><p class="first">4 spaces per indentation level.</p>
</li>
<li><p class="first">Variables are lower case meanwhile constants are upper case.</p>
</li>
<li><p class="first">Comments convention for functions is as follows:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>def <span class="k">function</span><span class="o">(</span>arg1, arg2<span class="o">)</span>:
    <span class="s1">&#39;&#39;&#39; This is a function.</span>

<span class="s1">        :param int arg1: array of dimensions ...</span>
<span class="s1">        :param str arg2: string that ...</span>
<span class="s1">    &#39;&#39;&#39;</span>
</pre></div>
</div>
</li>
<li><p class="first">The use of inline comments is sparingly.</p>
</li>
<li><p class="first">Use of lowercase to name functions. Furthermore, functions names have following form: <code class="docutils literal"><span class="pre">&lt;actionSubject&gt;()</span></code>, e.g. <code class="docutils literal"><span class="pre">computeMatrix()</span></code>.</p>
</li>
<li><p class="first">Use of whole words instead abbreviations, examples:</p>
<ul class="simple">
<li>Yes: <code class="docutils literal"><span class="pre">solveSystem()</span></code>, <code class="docutils literal"><span class="pre">computeEdges()</span></code>, <code class="docutils literal"><span class="pre">computeMatrix()</span></code>.</li>
<li>No: <code class="docutils literal"><span class="pre">solve()</span></code>, <code class="docutils literal"><span class="pre">compEdges()</span></code>, <code class="docutils literal"><span class="pre">compMatrix()</span></code>.</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="petgem-design">
<span id="id4"></span><h2><a class="toc-backref" href="#table-of-contents">PETGEM design</a><a class="headerlink" href="#petgem-design" title="Permalink to this headline">¶</a></h2>
<p>PETGEM use a code structure for the Nédelec FE algorithm that emphasizes
good parallel scalability, which is crucial in the multi-core era.
Furthermore, it’s modularity should simplify the process of reaching the
best possible performance in terms of percentage of the peak amount of
floating point operations provided by the architecture. The code structure is
modular, simple and flexible which allows exploiting not just PETGEM modules
but also third party libraries. Therefore, the software stack includes
interfaces to external suites of data structures and libraries that contain
most of the necessary building blocks needed for programming large scale
numerical applications, i.e. sparse matrices, vectors, iterative and direct
solvers. As a result, the code is compact and
flexible whose main UML diagrams are described as follows.</p>
<div class="section" id="component-diagram">
<h3><a class="toc-backref" href="#table-of-contents">Component diagram</a><a class="headerlink" href="#component-diagram" title="Permalink to this headline">¶</a></h3>
<p>Main components of PETGEM are described in <a class="reference internal" href="#figure-7-1">Figure 7.1</a>. Pre-processing,
processing and post-processing phases are included in <a class="reference internal" href="#figure-7-1">Figure 7.1</a>.</p>
<div class="figure align-center" id="id13">
<span id="figure-7-1"></span><a class="reference internal image-reference" href="_images/component_diagram.png"><img alt="PETGEM: component diagram." src="_images/component_diagram.png" style="width: 245.5px; height: 256.0px;" /></a>
<p class="caption"><span class="caption-text">Figure 7.1. PETGEM: class diagram.</span></p>
</div>
</div>
<div class="section" id="class-diagram">
<h3><a class="toc-backref" href="#table-of-contents">Class diagram</a><a class="headerlink" href="#class-diagram" title="Permalink to this headline">¶</a></h3>
<p>Main classes for PETGEM are described in <a class="reference internal" href="#figure-7-2">Figure 7.2</a>. Among all, the
<code class="docutils literal"><span class="pre">kernel</span></code> class is the most important since it manage and control the others
classes, as consequence, <code class="docutils literal"><span class="pre">kernel</span></code> class is the start point for any
modelling.</p>
<div class="figure align-center" id="id14">
<span id="figure-7-2"></span><a class="reference internal image-reference" href="_images/class_diagram.png"><img alt="PETGEM: class diagram." src="_images/class_diagram.png" style="width: 792.0px; height: 310.5px;" /></a>
<p class="caption"><span class="caption-text">Figure 7.2. PETGEM: class diagram.</span></p>
</div>
</div>
<div class="section" id="sequence-diagram">
<h3><a class="toc-backref" href="#table-of-contents">Sequence diagram</a><a class="headerlink" href="#sequence-diagram" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="#figure-7-3">Figure 7.3</a> describe the sequence for a standard CSEM forward modelling.</p>
<div class="figure align-center" id="id15">
<span id="figure-7-3"></span><a class="reference internal image-reference" href="_images/sequence_diagram.png"><img alt="PETGEM: sequence diagram." src="_images/sequence_diagram.png" style="width: 846.5px; height: 609.5px;" /></a>
<p class="caption"><span class="caption-text">Figure 7.3. PETGEM: sequence diagram.</span></p>
</div>
</div>
<div class="section" id="petgem-directory-structure">
<h3><a class="toc-backref" href="#table-of-contents">PETGEM directory structure</a><a class="headerlink" href="#petgem-directory-structure" title="Permalink to this headline">¶</a></h3>
<p>This subsection is dedicated to list and describe the PETGEM directory
structure.</p>
<table border="1" class="colwidths-given docutils" id="id16">
<caption><span class="caption-text">Top directory structure</span><a class="headerlink" href="#id16" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><cite>doc/</cite></td>
<td>Source files for PETGEM documentation</td>
</tr>
<tr class="row-odd"><td><cite>examples/</cite></td>
<td>Templates of basic scripts for 3D CSEM modelling</td>
</tr>
<tr class="row-even"><td><cite>petgem/</cite></td>
<td>Source code</td>
</tr>
<tr class="row-odd"><td><cite>kernel.py</cite></td>
<td>Heart of the code. This file contains the entire work-flow for a
3D CSEM survey</td>
</tr>
<tr class="row-even"><td><cite>run_preprocessing.py</cite></td>
<td>Pre-processing script for PETGEM</td>
</tr>
<tr class="row-odd"><td><cite>AUTHORS</cite></td>
<td>Authors file</td>
</tr>
<tr class="row-even"><td><cite>DESCRIPTION.rst</cite></td>
<td>Summary of PETGEM features, requirements and installation instructions</td>
</tr>
<tr class="row-odd"><td><cite>LICENSE.rst</cite></td>
<td>License file</td>
</tr>
<tr class="row-even"><td><cite>MANIFEST.in</cite></td>
<td>File with exact list of files to include in PETGEM distribution</td>
</tr>
<tr class="row-odd"><td><cite>README.rst</cite></td>
<td>Readme file</td>
</tr>
<tr class="row-even"><td><cite>setup.py</cite></td>
<td>Main PETGEM setup script, it is based on Python setup-module</td>
</tr>
<tr class="row-odd"><td><cite>setup.cfg</cite></td>
<td>Setup configuration file for PETGEM setup script</td>
</tr>
</tbody>
</table>
<p>The PETGEM source code is <cite>petgem/</cite>, which has the following contents:</p>
<table border="1" class="colwidths-given docutils" id="id17">
<caption><span class="caption-text"><cite>petgem/</cite> directory structure</span><a class="headerlink" href="#id17" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><cite>base/</cite></td>
<td>Common classes and functions for init process.</td>
</tr>
<tr class="row-odd"><td><cite>efem/</cite></td>
<td>General modules and classes for describing a 3D CSEM  survey by using EFEM of
lowest order in tetrahedral meshes</td>
</tr>
<tr class="row-even"><td><cite>mesh/</cite></td>
<td>Interface to import mesh files</td>
</tr>
<tr class="row-odd"><td><cite>monitoring/</cite></td>
<td>Modules for PETGEM performance monitoring</td>
</tr>
<tr class="row-even"><td><cite>parallel/</cite></td>
<td>Modules for supporting parallel assembling and solution of 3D CSEM</td>
</tr>
<tr class="row-odd"><td><cite>preprocessing/</cite></td>
<td>Modules for PETGEM pre-processing</td>
</tr>
<tr class="row-even"><td><cite>solver/</cite></td>
<td>Parallel functions within PETGEM and interface to <a class="reference external" href="https://www.mcs.anl.gov/petsc/">PETSc</a> solvers</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="pre-processing">
<span id="preprocessing-manual"></span><h2><a class="toc-backref" href="#table-of-contents">Pre-processing</a><a class="headerlink" href="#pre-processing" title="Permalink to this headline">¶</a></h2>
<p>The first step for a 3D CSEM modelling using PETGEM is the pre-processing
phase. Here, a mesh file (<a class="reference external" href="http://gmsh.info/">Gmsh</a> format) with its
conductivity model and receivers positions are exported to
<a class="reference external" href="https://www.mcs.anl.gov/petsc/">PETSc</a> binary files.</p>
<p>The <code class="docutils literal"><span class="pre">run_preprocessing.py</span></code> script provides functions to change these data
into a representation that is more suitable for PETGEM. The
<code class="docutils literal"><span class="pre">run_preprocessing.py</span></code> script is included in the top-level directory of
the PETGEM source tree.</p>
<p>The <code class="docutils literal"><span class="pre">run_preprocessing.py</span></code> script is invoked has follows:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ python3 run_preprocessing.py path/preprocessingParams.py
</pre></div>
</div>
<p>where <code class="docutils literal"><span class="pre">preprocessingParams.py</span></code> file contains parameters for the pre-processing
task. A glance of this file is the following:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Parameters file template for PETGEM preprocessing. Here a mesh file, conductivity model and receivers file are mandatory.</span>
<span class="c1"># In order to avoid a specific parser, this file is imported by PETGEM as a Python dictionary. As consequence, the dictionary</span>
<span class="c1"># name and his key names MUST NOT BE changed. All file paths should consider as absolute.</span>

<span class="n">preprocessing</span> <span class="o">=</span> <span class="p">{</span>
 <span class="c1"># ---------- Mesh file ----------</span>
 <span class="s1">&#39;MESH_FILE&#39;</span><span class="p">:</span> <span class="s1">&#39;DIPOLE1D/Input_preprocessing/DIPOLE1D.msh&#39;</span><span class="p">,</span>

 <span class="c1"># ---------- Material conductivities ----------</span>
 <span class="s1">&#39;MATERIAL_CONDUCTIVITIES&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="mf">100.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/.</span><span class="mi">3</span><span class="p">],</span>

 <span class="c1"># ---------- Receivers positions file ----------</span>
 <span class="s1">&#39;RECEIVERS_FILE&#39;</span><span class="p">:</span> <span class="s1">&#39;DIPOLE1D/Input_preprocessing/RECEIVER_POSITIONS.txt&#39;</span><span class="p">,</span>

 <span class="c1"># ---------- Path for Output ----------</span>
 <span class="s1">&#39;OUT_DIR&#39;</span><span class="p">:</span> <span class="s1">&#39;DIPOLE1D/Input_model/&#39;</span><span class="p">,</span>
 <span class="p">}</span>
</pre></div>
</div>
<p>As you can see, in the <code class="docutils literal"><span class="pre">preprocessingParams.py</span></code> are defined the main parameters,
namely, mesh file path, material conductivities, receivers positions file path and the
pre-processing output path.</p>
<p>For this phase, the supported/expected formats are the following:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">MESH_FILE</span></code>: path to tetrahedral mesh file in MSH ASCII format from <a class="reference external" href="http://gmsh.info/">Gmsh</a></p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">MATERIAL_CONDUCTIVITIES</span></code>: numpy array where each value represents the conductivity for each material defined in <code class="docutils literal"><span class="pre">MESH_FILE</span></code>. Therefore, size of <code class="docutils literal"><span class="pre">MATERIAL_CONDUCTIVITIES</span></code> must match with the number of materials in <code class="docutils literal"><span class="pre">MESH_FILE</span></code></p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">RECEIVERS_FILE</span></code>: floating point values giving the X, Y and Z coordinates of each receiver in ASCII format. Therefore, the number of receivers in the modelling will defined the number of the rows in <code class="docutils literal"><span class="pre">RECEIVERS_FILE</span></code>, i.e. if the modelling has 3 receivers, <code class="docutils literal"><span class="pre">RECEIVERS_FILE</span></code> should be:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="mf">5.8333300e+01</span>   <span class="mf">1.7500000e+03</span>  <span class="o">-</span><span class="mf">9.9000000e+02</span>
<span class="mf">1.1666670e+02</span>   <span class="mf">1.7500000e+03</span>  <span class="o">-</span><span class="mf">9.9000000e+02</span>
<span class="mf">1.7500000e+02</span>   <span class="mf">1.7500000e+03</span>  <span class="o">-</span><span class="mf">9.9000000e+02</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">OUT_DIR</span></code>: output path for pre-processing task</p>
</li>
</ul>
<p>Once the previous information has been provided, the <code class="docutils literal"><span class="pre">run_preprocessing.py</span></code>
script will generate all the input files required by PETGEM in order to
solve a 3D CSEM survey. The <code class="docutils literal"><span class="pre">run_preprocessing.py</span></code> output files list is the
following:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">nodes.dat</span></code>: floating point values giving the X, Y and Z coordinates of the four nodes that make up each tetrahedral element in the mesh. The dimensions of <code class="docutils literal"><span class="pre">nodes.dat</span></code> are given by (number-of-elements, 12)</li>
<li><code class="docutils literal"><span class="pre">meshConnectivity.dat</span></code>: list of the node number of the n-th tetrahedral element in the mesh. The dimensions of <code class="docutils literal"><span class="pre">meshConnectivity.dat</span></code> are given by (number-of-elements, 4)</li>
<li><code class="docutils literal"><span class="pre">dofs.dat</span></code>: list of degrees of freedom of the n-th tetrahedral element in the mesh. Since PETGEM is based on linear Nédelec FE, the dimensions of <code class="docutils literal"><span class="pre">dofs.dat</span></code> are given by (number-of-elements, 6)</li>
<li><code class="docutils literal"><span class="pre">dofsNodes.dat</span></code>: list of the two nodes that make up each degrees-of-freedom (DOFs) in the mesh. The dimensions of <code class="docutils literal"><span class="pre">dofsNodes.dat</span></code> are given by (number-of-dofs, 2)</li>
<li><code class="docutils literal"><span class="pre">boundaries.dat</span></code>: list of the DOFs number that belongs on domain boundaries. The dimensions of <code class="docutils literal"><span class="pre">boundaries.dat</span></code> are given by (number-of-boundaries, 1)</li>
<li><code class="docutils literal"><span class="pre">conductivityModel.dat</span></code>: floating point values giving the conductivity to which the n-th tetrahedral element belongs. The dimensions of <code class="docutils literal"><span class="pre">conductivityModel.dat</span></code> are given by (number-of-elements, 1)</li>
<li><code class="docutils literal"><span class="pre">receivers.dat</span></code>: floating point values giving the X, Y and Z coordinates of the receivers. Additionally, this file includes information about the tetrahedral element that contains the n-th receiver, namely, its X, Y and Z coordinates of the four nodes, its list of the node number and its list of DOFs. The dimensions of <code class="docutils literal"><span class="pre">receivers.dat</span></code> are given by (number-of-receivers, 25)</li>
<li><code class="docutils literal"><span class="pre">nnz.dat</span></code>: list containing the number of nonzeros in the various matrix rows, namely, the sparsity pattern. According to the <a class="reference external" href="http://www.mcs.anl.gov/petsc/">PETSc</a> documentation, using the <code class="docutils literal"><span class="pre">nnz.dat</span></code> list to preallocate memory is especially important for efficient matrix assembly if the number of nonzeros varies considerably among the rows. The dimensions of <code class="docutils literal"><span class="pre">nnz.dat</span></code> are given by (number-of-DOFs, 1)</li>
</ul>
<p>For each <code class="docutils literal"><span class="pre">*.dat</span></code> output file, the <code class="docutils literal"><span class="pre">run_preprocessing.py</span></code> script will
generate <code class="docutils literal"><span class="pre">*.info</span></code> files which are <a class="reference external" href="http://www.mcs.anl.gov/petsc/">PETSc</a>
control information.</p>
<p>For post-processing stage (interpolation of electric responses at receivers
positions) a point location function is needed. For this task, PETGEM is based
on <code class="docutils literal"><span class="pre">find_simplex</span></code> function by <a class="reference external" href="https://docs.scipy.org/doc/">Scipy</a>, which
find the tetrahedral elements (simplices) containing the given receivers
points. If some receivers positions are not found, PETGEM will print its
indexes and will save only those located points in the <code class="docutils literal"><span class="pre">receivers.dat</span></code>
file. Additionally, PETGEM will create <code class="docutils literal"><span class="pre">receiversPETGEM.txt</span></code> file with
floating point values giving the X, Y and Z coordinates of the located
receivers. Therefore, PETGEM will compute electric responses for located
receivers points.</p>
<p>A template of <code class="docutils literal"><span class="pre">run_preprocessing.py``script</span> <span class="pre">is</span> <span class="pre">included</span> <span class="pre">in</span> <span class="pre">the</span> <span class="pre">top-level</span>
<span class="pre">directory</span> <span class="pre">of</span> <span class="pre">the</span> <span class="pre">PETGEM</span>&#160; <span class="pre">source</span> <span class="pre">tree.</span> <span class="pre">On</span> <span class="pre">the</span> <span class="pre">other</span> <span class="pre">hand,</span> <span class="pre">a</span> <span class="pre">template</span> <span class="pre">of</span>
<span class="pre">``preprocessingParams.py</span></code> is included in <code class="docutils literal"><span class="pre">examples/</span></code>
of the PETGEM source tree. Additionally, a freely available copy of these files
is located at <a class="reference internal" href="Download.html#download"><span class="std std-ref">Download</span></a> section.</p>
</div>
<div class="section" id="running-a-simulation">
<span id="running-a-simulation-manual"></span><h2><a class="toc-backref" href="#table-of-contents">Running a simulation</a><a class="headerlink" href="#running-a-simulation" title="Permalink to this headline">¶</a></h2>
<p>This section introduces the basics of running PETGEM on the command
line. In order to solve a 3D CSEM survey, the PETGEM kernel requires two
files, namely, the <code class="docutils literal"><span class="pre">petsc.opts</span></code> file and the <code class="docutils literal"><span class="pre">modelParams.py</span></code> file, which
are described below.</p>
<p>Options for <a class="reference external" href="https://www.mcs.anl.gov/petsc/">PETSc</a> solvers/preconditioners
are accessible via the <code class="docutils literal"><span class="pre">petsc.opts</span></code> file, a glance of this is the
following:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Solver options for PETSc</span>
<span class="o">-</span><span class="n">ksp_type</span> <span class="n">gmres</span>
<span class="o">-</span><span class="n">pc_type</span> <span class="n">sor</span>
<span class="o">-</span><span class="n">ksp_rtol</span> <span class="mf">1e-8</span>
<span class="o">-</span><span class="n">ksp_converged_reason</span>
<span class="o">-</span><span class="n">ksp_monitor</span>
</pre></div>
</div>
<p>Please, see <a class="reference external" href="https://www.mcs.anl.gov/petsc/">PETSc</a> documentation for more
details about available options. A template of this file is included in
<code class="docutils literal"><span class="pre">examples/</span></code> of the PETGEM source tree. Additionally, a freely
available copy of this file is located at <a class="reference internal" href="Download.html#download"><span class="std std-ref">Download</span></a> section.</p>
<p>On the other hand, any 3D CSEM survey should include: physical parameters,
a mesh file, source and receivers files. These data are included in the
<code class="docutils literal"><span class="pre">modelParams.py</span></code> file. Here all the files resulting from the pre-processing
phase are included. In order to avoid a specific parser, <code class="docutils literal"><span class="pre">modelParams.py</span></code>
file is imported by PETGEM as a Python dictionary. As consequence, the
dictionary name and his key names MUST NOT BE changed.</p>
<p>A glance of <code class="docutils literal"><span class="pre">modelParams.py</span></code> file is the following:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Parameters file template for 3D CSEM modelling.</span>
<span class="c1"># By definition, any 3D CSEM survey should include: physical parameters, a mesh file, source and receivers files. These data</span>
<span class="c1"># are included in the modelParams.py file. Additionally, options for PETSc solvers are defined in a petsc.opts file.</span>
<span class="c1"># In order to avoid a specific parser, modelParams.py file is imported by PETGEM as a Python dictionary. As consequence,</span>
<span class="c1"># the dictionary name and his key names MUST NOT BE changed. All file paths should consider as absolute.</span>

<span class="n">modelling</span> <span class="o">=</span> <span class="p">{</span>
 <span class="c1"># ----- Pyshical parameters -----</span>
 <span class="c1"># Source</span>
 <span class="c1"># Source frequency. Type: float</span>
 <span class="c1"># Optional: NO</span>
 <span class="s1">&#39;FREQ&#39;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
 <span class="c1"># Source position(x, y, z). Type: float</span>
 <span class="c1"># Optional: NO</span>
 <span class="s1">&#39;SRC_POS&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1750.0</span><span class="p">,</span> <span class="mf">1750.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">975.0</span><span class="p">],</span>
 <span class="c1"># Source orientarion. Type: int</span>
 <span class="c1"># 1 = X-directed source</span>
 <span class="c1"># 2 = Y-directed source</span>
 <span class="c1"># 3 = Z-directed source</span>
 <span class="c1"># Optional: NO</span>
 <span class="s1">&#39;SRC_DIREC&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
 <span class="c1"># Source current. Type: float</span>
 <span class="c1"># Optional: NO</span>
 <span class="s1">&#39;SRC_CURRENT&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
 <span class="c1"># Source length. Type: float</span>
 <span class="c1"># Optional: NO</span>
 <span class="s1">&#39;SRC_LENGTH&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
 <span class="c1"># Conductivity model. Type: str</span>
 <span class="c1"># Optional: NO</span>
 <span class="s1">&#39;CONDUCTIVITY_MODEL_FILE&#39;</span><span class="p">:</span> <span class="s1">&#39;DIPOLE1D/Input_model/conductivityModel.dat&#39;</span><span class="p">,</span>
 <span class="c1"># Background conductivity. Type: float</span>
 <span class="c1"># Optional: NO</span>
 <span class="s1">&#39;CONDUCTIVITY_BACKGROUND&#39;</span><span class="p">:</span> <span class="mf">3.33</span><span class="p">,</span>

 <span class="c1"># ------- Mesh and conductivity model files ------</span>
 <span class="c1"># Mesh files</span>
 <span class="c1"># Nodes spatial coordinates. Type: str</span>
 <span class="c1"># Optional: NO</span>
 <span class="s1">&#39;NODES_FILE&#39;</span><span class="p">:</span> <span class="s1">&#39;DIPOLE1D/Input_model/nodes.dat&#39;</span><span class="p">,</span>
 <span class="c1"># Elements-nodes connectivity. Type: str</span>
 <span class="c1"># Optional: NO</span>
 <span class="s1">&#39;MESH_CONNECTIVITY_FILE&#39;</span><span class="p">:</span> <span class="s1">&#39;DIPOLE1D/Input_model/meshConnectivity.dat&#39;</span><span class="p">,</span>
 <span class="c1"># Elements-edges connectivity. Type: str</span>
 <span class="c1"># Optional: NO</span>
 <span class="s1">&#39;DOFS_CONNECTIVITY_FILE&#39;</span><span class="p">:</span> <span class="s1">&#39;DIPOLE1D/Input_model/dofs.dat&#39;</span><span class="p">,</span>
 <span class="c1"># Edges-nodes connectivity. Type: str</span>
 <span class="c1"># Optional: NO</span>
 <span class="s1">&#39;DOFS_NODES_FILE&#39;</span><span class="p">:</span> <span class="s1">&#39;DIPOLE1D/Input_model/dofsNodes.dat&#39;</span><span class="p">,</span>
 <span class="c1"># Sparsity pattern for matrix allocation (PETSc)</span>
 <span class="s1">&#39;NNZ_FILE&#39;</span><span class="p">:</span> <span class="s1">&#39;DIPOLE1D/Input_model/nnz.dat&#39;</span><span class="p">,</span>
 <span class="c1"># Boundaries. Type: str</span>
 <span class="c1"># Optional: NO</span>
 <span class="s1">&#39;BOUNDARIES_FILE&#39;</span><span class="p">:</span> <span class="s1">&#39;DIPOLE1D/Input_model/boundaries.dat&#39;</span><span class="p">,</span>

 <span class="c1"># ------------ Solver -----------</span>
 <span class="c1"># Solver options must be set in</span>
 <span class="c1"># petsc.opts file</span>

 <span class="c1"># ------------ Receivers file -----------</span>
 <span class="c1"># Name of the file that contains the receivers position. Type: str</span>
 <span class="c1"># Optional: NO</span>
 <span class="s1">&#39;RECEIVERS_FILE&#39;</span><span class="p">:</span> <span class="s1">&#39;DIPOLE1D/Input_model/receivers.dat&#39;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">modelParams.py</span></code> file is divided into 4 sections, namely, physical parameters
(frequency, source position, source current, source length, conductivity model,
background conductivity), mesh information (file path of nodal spatial coordinates,
mesh connectivity, DOFs connectivity, edges-nodes connectivity, sparsity
structure for <a class="reference external" href="https://www.mcs.anl.gov/petsc/">PETSc</a>
matrix allocation and boundaries), solver parameters (solver type, tolerance, maximum
number of iterations which are defined in the <code class="docutils literal"><span class="pre">petsc.opts</span></code> file),
output information (receivers positions file path).</p>
<p>A template of <code class="docutils literal"><span class="pre">modelParams.py</span></code> file is included in <code class="docutils literal"><span class="pre">examples/</span></code>
of the PETGEM source tree. Additionally, a freely available copy of this file
is located at <a class="reference internal" href="Download.html#download"><span class="std std-ref">Download</span></a> section.</p>
<p>Once the <code class="docutils literal"><span class="pre">petsc.opts</span></code> file and the <code class="docutils literal"><span class="pre">modelParams.py</span></code> file are ready, the
PETGEM kernel is invoked as follows:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ mpirun -n MPI_tasks python3 kernel.py -options_file path/petsc.opts path/modelParams.py
</pre></div>
</div>
<p>where <code class="docutils literal"><span class="pre">MPI_tasks</span></code> is the number of MPI parallel tasks, <code class="docutils literal"><span class="pre">kernel.py</span></code> is
the script that manages the PETGEM work-flow, <code class="docutils literal"><span class="pre">petsc.opts</span></code> is the
<a class="reference external" href="https://www.mcs.anl.gov/petsc/">PETSc</a> options file and <code class="docutils literal"><span class="pre">modelParams.py</span></code>
is the modelling parameters file for PETGEM.</p>
<p>PETGEM solves the problem and outputs the solution to the <code class="docutils literal"><span class="pre">Output/</span></code> path.
By default PETGEM will create the <code class="docutils literal"><span class="pre">Output</span></code> directory at same level where the
<code class="docutils literal"><span class="pre">modelParams.py</span></code> file is located. The output files will be in three formats:
<a class="reference external" href="https://www.mcs.anl.gov/petsc/">PETSc</a>, Matlab and ASCII. Therefore, the
<code class="docutils literal"><span class="pre">Output</span></code> directory will contain three subdirectories: <code class="docutils literal"><span class="pre">Ascii</span></code>, <code class="docutils literal"><span class="pre">Matlab</span></code>
and <code class="docutils literal"><span class="pre">Petsc</span></code>. By default, and for each format, PETGEM save the electric
field responses in different files:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">Ep.xx</span></code>: primary electric field components</li>
<li><code class="docutils literal"><span class="pre">Es.xx</span></code>: secondary electric field components</li>
<li><code class="docutils literal"><span class="pre">Et.xx</span></code>: total electric field components</li>
</ul>
<p>where <code class="docutils literal"><span class="pre">.xx</span></code> is the file extension that depends of the format file. If the
model has 3 receivers, <code class="docutils literal"><span class="pre">Et.dat</span></code> (<code class="docutils literal"><span class="pre">ASCII</span></code> format) would contain the three
components (X, Y, Z) of the total electric field responses as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Receiver                    X-component                                      Y-component                                         Z-component</span>
<span class="mi">0</span>          <span class="o">-</span><span class="mf">4.5574552863437594e-13</span><span class="o">+</span><span class="mf">7.1233021878258324e-13j</span>    <span class="mf">4.6739135897834993e-14</span><span class="o">+</span><span class="mf">2.5366912793221808e-14j</span>    <span class="o">-</span><span class="mf">3.1475221375383305e-13</span><span class="o">+</span><span class="mf">3.7062683392960539e-13j</span>
<span class="mi">1</span>          <span class="o">-</span><span class="mf">6.3279941549058795e-13</span><span class="o">+</span><span class="mf">7.1644275969040401e-13j</span>    <span class="mf">9.0092273989022595e-14</span><span class="o">+</span><span class="mf">5.6392191941229304e-14j</span>    <span class="o">-</span><span class="mf">5.3662476008883527e-13</span><span class="o">+</span><span class="mf">3.7808731666190081e-13j</span>
<span class="mi">2</span>          <span class="o">-</span><span class="mf">1.0010652368597410e-12</span><span class="o">+</span><span class="mf">7.0402832224144669e-13j</span>    <span class="mf">1.0689234928043421e-13</span><span class="o">+</span><span class="mf">3.6703286553521255e-14j</span>    <span class="o">-</span><span class="mf">7.8662575609351628e-13</span><span class="o">+</span><span class="mf">3.6350095199855107e-13j</span>
</pre></div>
</div>
<p>In summary, for a general 3D CSEM survey, the <code class="docutils literal"><span class="pre">kernel.py</span></code> script follows
the next work-flow:</p>
<ol class="arabic simple">
<li><code class="docutils literal"><span class="pre">kernel.py</span></code> reads a <code class="docutils literal"><span class="pre">modelParams.py</span></code></li>
<li>Following the contents of the <code class="docutils literal"><span class="pre">modelParams.py</span></code>, a problem instance is created</li>
<li>The problem sets up its domain, sub-domains, source, solver. This stage include the computation of the main data structures</li>
<li>Parallel assembling of <img class="math" src="_images/math/d275af031e98b6eb55e1438bf891a34a840441f7.png" alt="Ax=b"/>. See <a class="reference internal" href="CSEMEdges.html#csem-problem"><span class="std std-ref">CSEM problem</span></a> and <a class="reference internal" href="CSEMEdges.html#edge-finite-element-formulation"><span class="std std-ref">Edge finite element formulation</span></a> sections for a detail mathematical background of this equation system</li>
<li>The solution is obtained in parallel by calling a <code class="docutils literal"><span class="pre">ksp()</span></code> <a class="reference external" href="https://www.mcs.anl.gov/petsc/">PETSc</a> object.</li>
<li>Interpolation of electromagnetic responses &amp; post-processing parallel stage</li>
<li>Finally the solution can be stored by calling <code class="docutils literal"><span class="pre">postProcessingFields()</span></code> function. Current version support <a class="reference external" href="https://www.mcs.anl.gov/petsc/">PETSc</a>, Matlab and ASCII formats.</li>
</ol>
<p>Based on previous work-flow, any 3D CSEM modelling requires the following
input files:</p>
<ol class="arabic simple">
<li>A mesh file (current version supports mesh files in MSH ASCII format from <a class="reference external" href="http://gmsh.info/">Gmsh</a>)</li>
<li>A conductivity model associated with the materials defined in the mesh file</li>
<li>A list of receivers positions in ASCII format for the electric responses post-processing</li>
<li>A <code class="docutils literal"><span class="pre">preprocessingParams.py</span></code> file where are defined the pre-processing parameters</li>
<li>A <code class="docutils literal"><span class="pre">modelParams.py</span></code> file where are defined the 3D CSEM parameters</li>
<li>A <code class="docutils literal"><span class="pre">petsc.opts</span></code> file where are defined options for <a class="reference external" href="https://www.mcs.anl.gov/petsc/">PETSc</a> solvers</li>
<li>A <code class="docutils literal"><span class="pre">run_preprocessing.py</span></code> script and a <code class="docutils literal"><span class="pre">kernel.py</span></code> script which manage the pre-processing and modelling tasks respectively</li>
</ol>
</div>
<div class="section" id="mesh-formats">
<span id="id5"></span><h2><a class="toc-backref" href="#table-of-contents">Mesh formats</a><a class="headerlink" href="#mesh-formats" title="Permalink to this headline">¶</a></h2>
<p>Current PETGEM version supports mesh files in MSH ASCII from
<a class="reference external" href="http://gmsh.info/">Gmsh</a>. Aforementioned format must be pre-processed
using the <code class="docutils literal"><span class="pre">run_preprocessing.py</span></code> script. The <code class="docutils literal"><span class="pre">run_preprocessing.py</span></code>
script is included in the top-level directory of the PETGEM source tree.</p>
<p>See <a class="reference internal" href="#preprocessing-manual"><span class="std std-ref">Pre-processing</span></a> section for more details
about <code class="docutils literal"><span class="pre">run_preprocessing.py</span></code>.</p>
</div>
<div class="section" id="available-solvers">
<span id="id6"></span><h2><a class="toc-backref" href="#table-of-contents">Available solvers</a><a class="headerlink" href="#available-solvers" title="Permalink to this headline">¶</a></h2>
<p>This section describes solvers available in PETGEM from an user’s perspective.
Direct as well as iterative solvers and preconditioners are supported
through an interface to <a class="reference external" href="http://www.mcs.anl.gov/petsc/">PETSc</a> library.</p>
<p>PETGEM uses <a class="reference external" href="https://pypi.python.org/pypi/petsc4py">petsc4py</a> package in
order to support the Krylov Subspace Package (KSP) from
<a class="reference external" href="http://www.mcs.anl.gov/petsc/">PETSc</a>. The object KSP provides an
easy-to-use interface to the combination of a parallel Krylov iterative method
and a preconditioner (PC) or a sequential/parallel direct solver. As result,
PETGEM users can set various solver options and preconditioner
options at runtime via the <a class="reference external" href="https://www.mcs.anl.gov/petsc/">PETSc</a> options
database. These parameters are defined in the <code class="docutils literal"><span class="pre">petsc.opts</span></code> file.</p>
</div>
<div class="section" id="simulations-in-parallel">
<span id="id7"></span><h2><a class="toc-backref" href="#table-of-contents">Simulations in parallel</a><a class="headerlink" href="#simulations-in-parallel" title="Permalink to this headline">¶</a></h2>
<p>In FEM or EFEM simulations, the need for efficient algorithms for assembling the
matrices may be crucial, especially when the DOFs is considerably large. This
is the case for realistic scenarios of 3D CSEM surveys because the required
accuracy. In such situation, assembly process remains a critical portion of
the code optimization since solution of linear systems which asymptotically
dominates in large-scale computing, could be done with linear solvers such
as <a class="reference external" href="http://www.mcs.anl.gov/petsc/">PETSc</a>,
<a class="reference external" href="http://mumps.enseeiht.fr/">MUMPs</a>,
<a class="reference external" href="http://www.pardiso-project.org/">PARDISO</a>). In fact, in PETGEM V1.0,
the system assembly takes around $15%$ of the total time.</p>
<p>The classical assembly in FEM or EFEM programming is based on a loop over the
elements. Different techniques and algorithms have been proposed and nowadays is
possible performing these computations at the same time, i.e., to compute them in
parallel. However, parallel programming is not a trivial task in most programming
languages, and demands a strong theoretical knowledge about the hardware
architecture. Fortunately, <a class="reference external" href="https://www.python.org/">Python</a> presents user
friendly solutions for parallel computations, namely,
<a class="reference external" href="https://pypi.python.org/pypi/mpi4py">mpi4py</a> and
<a class="reference external" href="https://pypi.python.org/pypi/petsc4py">petsc4py</a> . These open-source
packages provides bindings of the MPI standard and the
<a class="reference external" href="http://www.mcs.anl.gov/petsc/">PETSc</a> library for the
<a class="reference external" href="https://www.python.org/">Python</a> programming language, allowing
any <a class="reference external" href="https://www.python.org/">Python</a> code to exploit multiple processors
architectures.</p>
<p>On top of that, <a class="reference internal" href="#figure-7-4">Figure 7.4</a> depicts shows an upper view of the matrix assembly
and solution using the <a class="reference external" href="https://pypi.python.org/pypi/mpi4py">mpi4py</a> and
<a class="reference external" href="https://pypi.python.org/pypi/petsc4py">petsc4py</a> package in PETGEM. The first
step is to partition the work-load into subdomains. This task can be done
by <a class="reference external" href="http://www.mcs.anl.gov/petsc/">PETSc</a> library, which makes load over
processes balanced. After domain partition, subdomains are assigned to MPI
tasks and the elemental matrices are calculated concurrently. These local
contributions are then accumulated into the global matrix system. The
process for global vector assembly is similar.</p>
<p>Subsequently, the system is ready to be solved. PETGEM uses the Krylov
Subspace Package (KSP) from <a class="reference external" href="http://www.mcs.anl.gov/petsc/">PETSc</a> through
the <a class="reference external" href="https://pypi.python.org/pypi/petsc4py">petsc4py</a> package. The KSP object
provides an easy-to-use interface to the combination of a parallel Krylov
iterative method and a preconditioner (PC) or a sequential/parallel direct
solver. As result, PETGEM users can set various solver options and
preconditioner options at runtime via the
<a class="reference external" href="http://www.mcs.anl.gov/petsc/">PETSc</a> options database. Since
<a class="reference external" href="http://www.mcs.anl.gov/petsc/">PETSc</a> knows which portions of the matrix
and vectors are locally owned by each processor, the post-processing task
is also completed in parallel following the numerical scheme
described in <a class="reference internal" href="CSEMEdges.html#csem-problem"><span class="std std-ref">CSEM problem</span></a> section.</p>
<p>All <a class="reference external" href="https://pypi.python.org/pypi/petsc4py">petsc4py</a> classes and
methods are called from the PETGEM kernel in a manner that allows a
parallel matrix and parallel vectors to be created automatically when the
code is run on many processors. Similarly, if only one processor is specified
the code will run in a sequential mode. Although
<a class="reference external" href="https://pypi.python.org/pypi/petsc4py">petsc4py</a> allows control the way
in which the matrices and vectors to be split across the processors
on the architecture, PETGEM simply let
<a class="reference external" href="https://pypi.python.org/pypi/petsc4py">petsc4py</a> decide the local sizes
in sake of computational flexibility. However, this can be modified in an
easy way without any extra coding required.</p>
<div class="figure align-center" id="id18">
<span id="figure-7-4"></span><a class="reference internal image-reference" href="_images/PETGEM_parallel_scheme.png"><img alt="Parallel scheme for assembly in PETGEM V1.0." src="_images/PETGEM_parallel_scheme.png" style="width: 699.3px; height: 362.59999999999997px;" /></a>
<p class="caption"><span class="caption-text">Figure 7.4. Parallel scheme for assembly and solution in PETGEM using 4 MPI tasks. Here the elemental matrices computation is done in parallel. After calculations the global system is built and solved in parallel using the petsc4py and mpi4py packages.</span></p>
</div>
</div>
<div class="section" id="visualization-of-results">
<span id="visualization-of-results-manual"></span><h2><a class="toc-backref" href="#table-of-contents">Visualization of results</a><a class="headerlink" href="#visualization-of-results" title="Permalink to this headline">¶</a></h2>
<p>Once a solution of a 3D CSEM survey has been obtained, it should be
post-processed by using a visualization program. PETGEM does not do the
visualization by itself, but it generates output files (ASCII,
<a class="reference external" href="https://www.mcs.anl.gov/petsc/">PETSc</a> and Matlab formats are supported)
with the electric responses at receivers positions. It also gives timing values
in order to evaluate the performance.</p>
<p><a class="reference internal" href="#figure-7-5">Figure 7.5</a> shows an example of PETGEM output for the first modelling case
(Canonical model of an off-shore hydrocarbon reservoir) described in
<a class="reference internal" href="#examples"><span class="std std-ref">Examples</span></a> section. <a class="reference internal" href="#figure-7-5">Figure 7.5</a> was obtained using
<a class="reference external" href="http://www.paraview.org/">Paraview</a>.</p>
<div class="figure align-center" id="id19">
<span id="figure-7-5"></span><a class="reference internal image-reference" href="_images/totalFieldVTK.png"><img alt="PETGEM vtk output." src="_images/totalFieldVTK.png" style="width: 685.0px; height: 422.5px;" /></a>
<p class="caption"><span class="caption-text">Figure 7.5. PETGEM vtk output.</span></p>
</div>
</div>
<div class="section" id="examples">
<span id="id8"></span><h2><a class="toc-backref" href="#table-of-contents">Examples</a><a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<p>This section includes a step-by-step walk-through of the process to solve a
simple 3D CSEM survey. The typical process to solve a problem using
PETGEM is followed: a model is meshed, PETGEM input files are preprocessed by
using <code class="docutils literal"><span class="pre">run_preprocessing.py</span></code> script (see <a class="reference internal" href="#preprocessing-manual"><span class="std std-ref">Pre-processing</span></a> section
for details), a <code class="docutils literal"><span class="pre">modelParams.py</span></code> file is drafted, PETGEM is run to solve
the modelling and finally the results of the simulation are visualised.</p>
<p>All necessary data to reproduce the following examples are available in the
<a class="reference internal" href="Download.html#download"><span class="std std-ref">Download</span></a> section.</p>
<div class="section" id="example-1-pre-processing-data-for-petgem">
<h3><a class="toc-backref" href="#table-of-contents">Example 1: Pre-processing data for PETGEM</a><a class="headerlink" href="#example-1-pre-processing-data-for-petgem" title="Permalink to this headline">¶</a></h3>
<div class="section" id="model">
<h4><a class="toc-backref" href="#table-of-contents">Model</a><a class="headerlink" href="#model" title="Permalink to this headline">¶</a></h4>
<p>In order to explain the PETGEM pre-processing stage, here is considered the
simple layer model of <a class="reference internal" href="#figure-7-6">Figure 7.6</a>. The model consists in two-layers: 500 m
thick seawater (3.3 <img class="math" src="_images/math/1ab98880e07cc102c8b27c778be235fa35447d60.png" alt="S/m"/>), 500 m thick sediments (1 <img class="math" src="_images/math/1ab98880e07cc102c8b27c778be235fa35447d60.png" alt="S/m"/>).</p>
<div class="figure align-center" id="id20">
<span id="figure-7-6"></span><a class="reference internal image-reference" href="_images/model_preprocessing.png"><img alt="Simple conductivity for pre-processing stage in PETGEM" src="_images/model_preprocessing.png" style="width: 467.59999999999997px; height: 374.15px;" /></a>
<p class="caption"><span class="caption-text">Figure 7.6. Simple conductivity for pre-processing stage in PETGEM</span></p>
</div>
<p>This model has been meshed using the <a class="reference external" href="http://gmsh.info/">Gmsh</a> tool. The
mesh geometry for this example is defined in the <code class="docutils literal"><span class="pre">PREPROCESSING.geo</span></code> script,
which content is the following:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="o">/*********************************************************************</span>
<span class="o">*</span>
<span class="o">*</span> <span class="n">Mesh</span> <span class="k">for</span> <span class="n">pre</span><span class="o">-</span><span class="n">processing</span> <span class="n">stage</span> <span class="ow">in</span> <span class="n">PETGEM</span> <span class="p">(</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">petgem</span><span class="o">.</span><span class="n">bsc</span><span class="o">.</span><span class="n">es</span><span class="o">/</span><span class="p">)</span>
<span class="o">*</span>
<span class="o">*</span> <span class="n">Parameters</span><span class="p">:</span>
<span class="o">*</span>    <span class="n">Conductivity</span> <span class="p">[</span><span class="n">Sediments</span><span class="p">,</span> <span class="n">Water</span><span class="p">]</span> <span class="o">--&gt;</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">0.3</span><span class="p">]</span> <span class="n">S</span><span class="o">/</span><span class="n">m</span>
<span class="o">*</span>    <span class="n">x</span><span class="o">-</span><span class="n">dimensions</span> <span class="o">--&gt;</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1500.0</span><span class="p">]</span> <span class="n">m</span>
<span class="o">*</span>    <span class="n">y</span><span class="o">-</span><span class="n">dimensions</span> <span class="o">--&gt;</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1500.0</span><span class="p">]</span> <span class="n">m</span>
<span class="o">*</span>    <span class="n">z</span><span class="o">-</span><span class="n">dimensions</span> <span class="o">--&gt;</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1000.0</span><span class="p">]</span> <span class="n">m</span>
<span class="o">*</span>
<span class="o">*</span> <span class="n">Visit</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">gmsh</span><span class="o">.</span><span class="n">info</span><span class="o">/</span> <span class="k">for</span> <span class="n">details</span> <span class="n">about</span> <span class="n">mesh</span> <span class="n">scripting</span> <span class="k">with</span> <span class="n">Gmsh</span>
<span class="o">*</span>
<span class="o">*</span> <span class="n">by</span> <span class="n">Octavio</span> <span class="n">Castillo</span><span class="o">-</span><span class="n">Reyes</span><span class="p">,</span> <span class="n">BSC</span><span class="o">-</span><span class="n">CASE</span> <span class="p">(</span><span class="n">octavio</span><span class="o">.</span><span class="n">castillo</span><span class="nd">@bsc.es</span><span class="p">)</span>
<span class="o">*</span> <span class="n">Latest</span> <span class="n">update</span><span class="p">:</span> <span class="n">January</span> <span class="mi">30</span><span class="n">th</span><span class="p">,</span> <span class="mi">2018</span>
<span class="o">*********************************************************************/</span>
<span class="o">//</span> <span class="c1">#################################################################</span>
<span class="o">//</span> <span class="c1">#                        Parameters                             #</span>
<span class="o">//</span> <span class="c1">#################################################################</span>
<span class="o">//</span> <span class="n">Dimensions</span>
<span class="n">MIN_X</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.0</span><span class="p">;</span>
<span class="n">MAX_X</span> <span class="o">=</span> <span class="mf">1500.0</span><span class="p">;</span>
<span class="n">MIN_Y</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
<span class="n">MAX_Y</span> <span class="o">=</span> <span class="mf">1500.0</span><span class="p">;</span>
<span class="n">MIN_Z</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1000.0</span><span class="p">;</span>
<span class="n">MAX_Z</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
<span class="n">DEPTH_MATERIAL1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">500.0</span><span class="p">;</span>
<span class="o">//</span> <span class="n">Mesh</span> <span class="n">size</span>
<span class="n">dg</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>
<span class="o">//</span> <span class="c1">#################################################################</span>
<span class="o">//</span> <span class="c1">#                    Define main points                         #</span>
<span class="o">//</span> <span class="c1">#################################################################</span>
<span class="n">Point</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="n">MIN_X</span><span class="p">,</span> <span class="n">MIN_Y</span><span class="p">,</span> <span class="n">MIN_Z</span><span class="p">};</span>
<span class="n">Point</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="n">MIN_X</span><span class="p">,</span> <span class="n">MAX_Y</span><span class="p">,</span> <span class="n">MIN_Z</span><span class="p">};</span>
<span class="n">Point</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="n">MAX_X</span><span class="p">,</span> <span class="n">MAX_Y</span><span class="p">,</span> <span class="n">MIN_Z</span><span class="p">};</span>
<span class="n">Point</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="n">MAX_X</span><span class="p">,</span> <span class="n">MIN_Y</span><span class="p">,</span> <span class="n">MIN_Z</span><span class="p">};</span>
<span class="n">Point</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="n">MIN_X</span><span class="p">,</span> <span class="n">MIN_Y</span><span class="p">,</span> <span class="n">DEPTH_MATERIAL1</span><span class="p">};</span>
<span class="n">Point</span> <span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="n">MIN_X</span><span class="p">,</span> <span class="n">MAX_Y</span><span class="p">,</span> <span class="n">DEPTH_MATERIAL1</span><span class="p">};</span>
<span class="n">Point</span> <span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="n">MAX_X</span><span class="p">,</span> <span class="n">MAX_Y</span><span class="p">,</span> <span class="n">DEPTH_MATERIAL1</span><span class="p">};</span>
<span class="n">Point</span> <span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="n">MAX_X</span><span class="p">,</span> <span class="n">MIN_Y</span><span class="p">,</span> <span class="n">DEPTH_MATERIAL1</span><span class="p">};</span>
<span class="n">Point</span> <span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="n">MIN_X</span><span class="p">,</span> <span class="n">MIN_Y</span><span class="p">,</span> <span class="n">MAX_Z</span><span class="p">};</span>
<span class="n">Point</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="n">MIN_X</span><span class="p">,</span> <span class="n">MAX_Y</span><span class="p">,</span> <span class="n">MAX_Z</span><span class="p">};</span>
<span class="n">Point</span> <span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="n">MAX_X</span><span class="p">,</span> <span class="n">MAX_Y</span><span class="p">,</span> <span class="n">MAX_Z</span><span class="p">};</span>
<span class="n">Point</span> <span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="n">MAX_X</span><span class="p">,</span> <span class="n">MIN_Y</span><span class="p">,</span> <span class="n">MAX_Z</span><span class="p">};</span>

<span class="o">//</span> <span class="c1">#################################################################</span>
<span class="o">//</span> <span class="c1">#                   Layer 1: Sediments (1.0 S/m)                #</span>
<span class="o">//</span> <span class="c1">#################################################################</span>
<span class="n">Line</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">};</span>
<span class="n">Line</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">};</span>
<span class="n">Line</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">};</span>
<span class="n">Line</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">};</span>
<span class="n">Line</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">};</span>
<span class="n">Line</span> <span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">};</span>
<span class="n">Line</span> <span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">};</span>
<span class="n">Line</span> <span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">};</span>
<span class="n">Line</span> <span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">};</span>
<span class="n">Line</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">};</span>
<span class="n">Line</span> <span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">};</span>
<span class="n">Line</span> <span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">};</span>
<span class="n">Line</span> <span class="n">Loop</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">};</span>
<span class="n">Plane</span> <span class="n">Surface</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">};</span>
<span class="n">Line</span> <span class="n">Loop</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mi">9</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">};</span>
<span class="n">Plane</span> <span class="n">Surface</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">};</span>
<span class="n">Line</span> <span class="n">Loop</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">};</span>
<span class="n">Plane</span> <span class="n">Surface</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">3</span><span class="p">};</span>
<span class="n">Line</span> <span class="n">Loop</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="o">-</span><span class="mi">11</span><span class="p">,</span> <span class="o">-</span><span class="mi">7</span><span class="p">};</span>
<span class="n">Plane</span> <span class="n">Surface</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">4</span><span class="p">};</span>
<span class="n">Line</span> <span class="n">Loop</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">12</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">};</span>
<span class="n">Plane</span> <span class="n">Surface</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">5</span><span class="p">};</span>
<span class="n">Line</span> <span class="n">Loop</span> <span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">};</span>
<span class="n">Plane</span> <span class="n">Surface</span> <span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">6</span><span class="p">};</span>
<span class="o">//</span> <span class="n">Define</span> <span class="n">Volume</span>
<span class="n">Surface</span> <span class="n">Loop</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">};</span>
<span class="n">Volume</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">};</span>
<span class="n">Physical</span> <span class="n">Volume</span> <span class="p">(</span><span class="s2">&quot;Sediments&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">};</span>

<span class="o">//</span> <span class="c1">#################################################################</span>
<span class="o">//</span> <span class="c1">#                 Layer 2: Water (1.0/0.3 S/m)                  #</span>
<span class="o">//</span> <span class="c1">#################################################################</span>
<span class="n">Line</span> <span class="p">(</span><span class="mi">13</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">};</span>
<span class="n">Line</span> <span class="p">(</span><span class="mi">14</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">7</span><span class="p">,</span> <span class="mi">11</span><span class="p">};</span>
<span class="n">Line</span> <span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">};</span>
<span class="n">Line</span> <span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">5</span><span class="p">,</span> <span class="mi">9</span><span class="p">};</span>
<span class="n">Line</span> <span class="p">(</span><span class="mi">17</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">9</span><span class="p">,</span> <span class="mi">12</span><span class="p">};</span>
<span class="n">Line</span> <span class="p">(</span><span class="mi">18</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">12</span><span class="p">,</span> <span class="mi">11</span><span class="p">};</span>
<span class="n">Line</span> <span class="p">(</span><span class="mi">19</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">11</span><span class="p">,</span> <span class="mi">10</span><span class="p">};</span>
<span class="n">Line</span> <span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span> <span class="mi">9</span><span class="p">};</span>
<span class="n">Line</span> <span class="n">Loop</span> <span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">9</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="o">-</span><span class="mi">17</span><span class="p">,</span> <span class="o">-</span><span class="mi">16</span><span class="p">};</span>
<span class="n">Plane</span> <span class="n">Surface</span> <span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">7</span><span class="p">};</span>
<span class="n">Line</span> <span class="n">Loop</span> <span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="o">-</span><span class="mi">18</span><span class="p">,</span> <span class="o">-</span><span class="mi">13</span><span class="p">};</span>
<span class="n">Plane</span> <span class="n">Surface</span> <span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">8</span><span class="p">};</span>
<span class="n">Line</span> <span class="n">Loop</span> <span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">11</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="o">-</span><span class="mi">19</span><span class="p">,</span><span class="o">-</span><span class="mi">14</span><span class="p">};</span>
<span class="n">Plane</span> <span class="n">Surface</span> <span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">9</span><span class="p">};</span>
<span class="n">Line</span> <span class="n">Loop</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="o">-</span><span class="mi">15</span><span class="p">};</span>
<span class="n">Plane</span> <span class="n">Surface</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">10</span><span class="p">};</span>
<span class="n">Line</span> <span class="n">Loop</span> <span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">20</span><span class="p">};</span>
<span class="n">Plane</span> <span class="n">Surface</span> <span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">11</span><span class="p">};</span>
<span class="o">//</span> <span class="n">Define</span> <span class="n">Volume</span>
<span class="n">Surface</span> <span class="n">Loop</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">};</span>
<span class="n">Volume</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">};</span>
<span class="n">Physical</span> <span class="n">Volume</span> <span class="p">(</span><span class="s2">&quot;Water&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">};</span>

<span class="o">//</span> <span class="c1">#################################################################</span>
<span class="o">//</span> <span class="c1">#                Mesh parameters                                #</span>
<span class="o">//</span> <span class="c1">#################################################################</span>
<span class="n">Characteristic</span> <span class="n">Length</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span> <span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">20</span><span class="p">}</span> <span class="o">=</span> <span class="n">dg</span><span class="p">;</span>
</pre></div>
</div>
<p>Once the mesh have been created, the PETGEM pre-processing is invoked as
follows:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ python3 run_preprocessing.py PREPROCESSING/preprocessingParams.py
</pre></div>
</div>
<p>where <code class="docutils literal"><span class="pre">preprocessingParams.py</span></code> file contains parameters for the pre-processing
task. A glance of this script is the following:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Parameters file template for PETGEM preprocessing. Here a mesh file, conductivity model and receivers file are mandatory.</span>
<span class="c1"># In order to avoid a specific parser, this file is imported by PETGEM as a Python dictionary. As consequence, the dictionary</span>
<span class="c1"># name and his key names MUST NOT BE changed. All file paths should consider as absolute.</span>

<span class="n">preprocessing</span> <span class="o">=</span> <span class="p">{</span>
 <span class="c1"># ---------- Mesh file ----------</span>
 <span class="s1">&#39;MESH_FILE&#39;</span><span class="p">:</span> <span class="s1">&#39;PREPROCESSING/Input_preprocessing/PREPROCESSING.msh&#39;</span><span class="p">,</span>

 <span class="c1"># ---------- Material conductivities ----------</span>
 <span class="s1">&#39;MATERIAL_CONDUCTIVITIES&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/.</span><span class="mi">3</span><span class="p">],</span>

 <span class="c1"># ---------- Receivers positions file ----------</span>
 <span class="s1">&#39;RECEIVERS_FILE&#39;</span><span class="p">:</span> <span class="s1">&#39;PREPROCESSING/Input_preprocessing/RECEIVER_POSITIONS.txt&#39;</span><span class="p">,</span>

 <span class="c1"># ---------- Path for Output ----------</span>
 <span class="s1">&#39;OUT_DIR&#39;</span><span class="p">:</span> <span class="s1">&#39;Input_model/&#39;</span><span class="p">,</span>
 <span class="p">}</span>
</pre></div>
</div>
<p>As you can see, in the <code class="docutils literal"><span class="pre">preprocessingParams.py</span></code> are defined the main parameters,
namely, mesh file path, material conductivities, receivers positions file path and the
pre-processing output path.</p>
<p>The expected output of this phase is show in <a class="reference internal" href="#figure-7-7">Figure 7.7</a>.</p>
<div class="figure align-center" id="id21">
<span id="figure-7-7"></span><a class="reference internal image-reference" href="_images/output_preprocessing.png"><img alt="PETGEM output for pre-processing stage" src="_images/output_preprocessing.png" style="width: 450.79999999999995px; height: 435.75px;" /></a>
<p class="caption"><span class="caption-text">Figure 7.7. PETGEM output for pre-processing stage</span></p>
</div>
<p>Previous task, will prepare all input files for 3D CSEM modeling within
PETGEM. Please, see <a class="reference internal" href="#preprocessing-manual"><span class="std std-ref">Pre-processing</span></a> section for details about
pre-processing output files.</p>
</div>
</div>
<div class="section" id="example-2-canonical-model-of-an-off-shore-hydrocarbon-reservoir">
<h3><a class="toc-backref" href="#table-of-contents">Example 2: Canonical model of an off-shore hydrocarbon reservoir</a><a class="headerlink" href="#example-2-canonical-model-of-an-off-shore-hydrocarbon-reservoir" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id9">
<h4><a class="toc-backref" href="#table-of-contents">Model</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h4>
<p>In order to explain the 3D CSEM modelling using PETGEM, here is considered the
canonical model by
<a class="reference external" href="http://marineemlab.ucsd.edu/steve/bio/ThinResistors.pdf">Weiss2006</a> which
consists in four-layers: 1000 m thick seawater (3.3 <img class="math" src="_images/math/1ab98880e07cc102c8b27c778be235fa35447d60.png" alt="S/m"/>), 1000 m thick sediments
(1 <img class="math" src="_images/math/1ab98880e07cc102c8b27c778be235fa35447d60.png" alt="S/m"/>), 100 m thick oil (0.01 <img class="math" src="_images/math/1ab98880e07cc102c8b27c778be235fa35447d60.png" alt="S/m"/>) and 1400 m thick sediments
(1 <img class="math" src="_images/math/1ab98880e07cc102c8b27c778be235fa35447d60.png" alt="S/m"/>). The computational domain is a <img class="math" src="_images/math/302f31b1a918dd143d53dab4649346d85a8fa792.png" alt="[0,3500]^3"/> m cube. For this model,
a 2 Hz x-directed dipole source is located at <img class="math" src="_images/math/dad48cd4c5cab157b7c283308b11d4ba1bbb037c.png" alt="z=975"/>, <img class="math" src="_images/math/7f940eafc240052d58ba29449f1b42f362d728a5.png" alt="x=1750"/>,
<img class="math" src="_images/math/e7e68cfb93d1957dc2310ad17a25221b7e397f18.png" alt="y=1750"/>. The receivers are placed in-line to the source position and along its
orientation, directly above the seafloor (<img class="math" src="_images/math/26a8dcae237b2cc1c4af9341b5ad47b43501f34f.png" alt="z = 990"/>).</p>
</div>
<div class="section" id="meshing">
<h4><a class="toc-backref" href="#table-of-contents">Meshing</a><a class="headerlink" href="#meshing" title="Permalink to this headline">¶</a></h4>
<p>PETGEM V1.0 is based on tetrahedral meshes of lowest order. Therefore,  <a class="reference internal" href="#figure-7-8">Figure 7.8</a>
shows a 3D view of the model with its unstructured tetrahedral mesh for
the halfspace <img class="math" src="_images/math/12de4daabfac3d325423a62d25e1c644d7aff1c5.png" alt="y&gt;1750"/>, with the color scale representing the electrical
conductivity <img class="math" src="_images/math/011e5790a6c33043ceadca81d9657dde6c61d769.png" alt="\sigma"/> for each layer. Mesh in <a class="reference internal" href="#figure-7-8">Figure 7.8</a> have been
obtained using <a class="reference external" href="http://gmsh.info/">Gmsh</a>.</p>
<div class="figure align-center" id="id22">
<span id="figure-7-8"></span><a class="reference internal image-reference" href="_images/model1.png"><img alt="In-line canonical off-shore hydrocarbon model with its unstructured tetrahedral mesh for :math:`y&gt;150`" src="_images/model1.png" style="width: 723.4499999999999px; height: 413.34999999999997px;" /></a>
<p class="caption"><span class="caption-text">Figure 7.8. In-line canonical off-shore hydrocarbon model with its unstructured tetrahedral mesh for <img class="math" src="_images/math/12de4daabfac3d325423a62d25e1c644d7aff1c5.png" alt="y&gt;1750"/>. The color scale represents the electrical conductivity <img class="math" src="_images/math/011e5790a6c33043ceadca81d9657dde6c61d769.png" alt="\sigma"/> for each layer.</span></p>
</div>
<p>In this case, the mesh is composed by four conductivity materials. Please, see
<a class="reference external" href="http://gmsh.info/">Gmsh</a> manual for details about the mesh creation process.</p>
</div>
<div class="section" id="petgem-pre-processing">
<h4><a class="toc-backref" href="#table-of-contents">PETGEM pre-processing</a><a class="headerlink" href="#petgem-pre-processing" title="Permalink to this headline">¶</a></h4>
<p>The next step in the process is the PETGEM input files construction. These files can be
created using the <code class="docutils literal"><span class="pre">run_preprocessing.py</span></code> script. For this modelling,
<code class="docutils literal"><span class="pre">run_preprocessing.py</span></code> should be invoked has follows:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ python3 run_preprocessing.py DIPOLE1D/preprocessingParams.py
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">run_preprocessing.py</span></code> script will create 8 files in binary
<a class="reference external" href="https://www.mcs.anl.gov/petsc/">PETSc</a> format:
<code class="docutils literal"><span class="pre">nodes.dat</span></code>, <code class="docutils literal"><span class="pre">meshConnectivity.dat</span></code>, <code class="docutils literal"><span class="pre">dofs.dat</span></code>, <code class="docutils literal"><span class="pre">dofsNodes.dat</span></code>,
<code class="docutils literal"><span class="pre">boundaries.dat</span></code>, <code class="docutils literal"><span class="pre">conductivityModel.dat</span></code>, <code class="docutils literal"><span class="pre">receivers.dat</span></code> and
<code class="docutils literal"><span class="pre">nnz.dat</span></code> with its corresponding <code class="docutils literal"><span class="pre">*.info</span></code> files.</p>
</div>
<div class="section" id="parameters-file-for-petgem">
<h4><a class="toc-backref" href="#table-of-contents">Parameters file for PETGEM</a><a class="headerlink" href="#parameters-file-for-petgem" title="Permalink to this headline">¶</a></h4>
<p>The parameters file structure for PETGEM is well documented in
<a class="reference internal" href="#running-a-simulation-manual"><span class="std std-ref">Running a simulation</span></a> section. The parameters file used for
this example follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Parameters file template for 3D CSEM modelling.</span>
<span class="c1"># By definition, any 3D CSEM survey should include: physical parameters, a mesh file, source and receivers files. These data</span>
<span class="c1"># are included in the modelParams.py file. Additionally, options for PETSc solvers are defined in a petsc.opts file.</span>
<span class="c1"># In order to avoid a specific parser, modelParams.py file is imported by PETGEM as a Python dictionary. As consequence,</span>
<span class="c1"># the dictionary name and his key names MUST NOT BE changed. All file paths should consider as absolute.</span>

<span class="n">modelling</span> <span class="o">=</span> <span class="p">{</span>
 <span class="c1"># ----- Pyshical parameters -----</span>
 <span class="c1"># Source</span>
 <span class="c1"># Source frequency. Type: float</span>
 <span class="c1"># Optional: NO</span>
 <span class="s1">&#39;FREQ&#39;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
 <span class="c1"># Source position(x, y, z). Type: float</span>
 <span class="c1"># Optional: NO</span>
 <span class="s1">&#39;SRC_POS&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1750.0</span><span class="p">,</span> <span class="mf">1750.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">975.0</span><span class="p">],</span>
 <span class="c1"># Source orientarion. Type: int</span>
 <span class="c1"># 1 = X-directed source</span>
 <span class="c1"># 2 = Y-directed source</span>
 <span class="c1"># 3 = Z-directed source</span>
 <span class="c1"># Optional: NO</span>
 <span class="s1">&#39;SRC_DIREC&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
 <span class="c1"># Source current. Type: float</span>
 <span class="c1"># Optional: NO</span>
 <span class="s1">&#39;SRC_CURRENT&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
 <span class="c1"># Source length. Type: float</span>
 <span class="c1"># Optional: NO</span>
 <span class="s1">&#39;SRC_LENGTH&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
 <span class="c1"># Conductivity model. Type: str</span>
 <span class="c1"># Optional: NO</span>
 <span class="s1">&#39;CONDUCTIVITY_MODEL_FILE&#39;</span><span class="p">:</span> <span class="s1">&#39;DIPOLE1D/Input_model/conductivityModel.dat&#39;</span><span class="p">,</span>
 <span class="c1"># Background conductivity. Type: float</span>
 <span class="c1"># Optional: NO</span>
 <span class="s1">&#39;CONDUCTIVITY_BACKGROUND&#39;</span><span class="p">:</span> <span class="mf">3.33</span><span class="p">,</span>

 <span class="c1"># ------- Mesh and conductivity model files ------</span>
 <span class="c1"># Mesh files</span>
 <span class="c1"># Nodes spatial coordinates. Type: str</span>
 <span class="c1"># Optional: NO</span>
 <span class="s1">&#39;NODES_FILE&#39;</span><span class="p">:</span> <span class="s1">&#39;DIPOLE1D/Input_model/nodes.dat&#39;</span><span class="p">,</span>
 <span class="c1"># Elements-nodes connectivity. Type: str</span>
 <span class="c1"># Optional: NO</span>
 <span class="s1">&#39;MESH_CONNECTIVITY_FILE&#39;</span><span class="p">:</span> <span class="s1">&#39;DIPOLE1D/Input_model/meshConnectivity.dat&#39;</span><span class="p">,</span>
 <span class="c1"># Elements-edges connectivity. Type: str</span>
 <span class="c1"># Optional: NO</span>
 <span class="s1">&#39;DOFS_CONNECTIVITY_FILE&#39;</span><span class="p">:</span> <span class="s1">&#39;DIPOLE1D/Input_model/dofs.dat&#39;</span><span class="p">,</span>
 <span class="c1"># Edges-nodes connectivity. Type: str</span>
 <span class="c1"># Optional: NO</span>
 <span class="s1">&#39;DOFS_NODES_FILE&#39;</span><span class="p">:</span> <span class="s1">&#39;DIPOLE1D/Input_model/dofsNodes.dat&#39;</span><span class="p">,</span>
 <span class="c1"># Sparsity pattern for matrix allocation (PETSc)</span>
 <span class="s1">&#39;NNZ_FILE&#39;</span><span class="p">:</span> <span class="s1">&#39;DIPOLE1D/Input_model/nnz.dat&#39;</span><span class="p">,</span>
 <span class="c1"># Boundaries. Type: str</span>
 <span class="c1"># Optional: NO</span>
 <span class="s1">&#39;BOUNDARIES_FILE&#39;</span><span class="p">:</span> <span class="s1">&#39;DIPOLE1D/Input_model/boundaries.dat&#39;</span><span class="p">,</span>

 <span class="c1"># ------------ Solver -----------</span>
 <span class="c1"># Solver options must be set in</span>
 <span class="c1"># petsc.opts file</span>

 <span class="c1"># ------------ Receivers file -----------</span>
 <span class="c1"># Name of the file that contains the receivers position. Type: str</span>
 <span class="c1"># Optional: NO</span>
 <span class="s1">&#39;RECEIVERS_FILE&#39;</span><span class="p">:</span> <span class="s1">&#39;DIPOLE1D/Input_model/receivers.dat&#39;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that you may wish to change the location of the input files to
somewhere on your drive. By default PETGEM will create the <code class="docutils literal"><span class="pre">Output</span></code> directory
at same level where the <code class="docutils literal"><span class="pre">modelParams.py</span></code> file is located. For this example
and following the <a class="reference external" href="https://www.mcs.anl.gov/petsc/">PETSc</a> documentation,
the solver options have been configured in the <code class="docutils literal"><span class="pre">petsc.opts</span></code> file as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Solver options for PETSc</span>
<span class="o">-</span><span class="n">ksp_type</span> <span class="n">gmres</span>
<span class="o">-</span><span class="n">pc_type</span> <span class="n">sor</span>
<span class="o">-</span><span class="n">ksp_rtol</span> <span class="mf">1e-8</span>
<span class="o">-</span><span class="n">ksp_converged_reason</span>
<span class="o">-</span><span class="n">log_summary</span>
</pre></div>
</div>
<p>That’s it, we are now ready to solve the modelling.</p>
</div>
<div class="section" id="running-petgem">
<h4><a class="toc-backref" href="#table-of-contents">Running PETGEM</a><a class="headerlink" href="#running-petgem" title="Permalink to this headline">¶</a></h4>
<p>To run the simulation, the following command should be run in the top-level
directory of the PETGEM source tree:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ mpirun -n <span class="m">16</span> python3 kernel.py -options_file DIPOLE1D/petsc.opts DIPOLE1D/modelParams.py
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">kernel.py</span></code> solves the problem as follows:</p>
<ol class="arabic simple">
<li>Problem initialization</li>
<li>Import files</li>
<li>Parallel assembly system</li>
<li>Parallel solution system</li>
<li>Post-processing of electric responses</li>
</ol>
<p>and outputs the solution to the output path
(<code class="docutils literal"><span class="pre">DIPOLE1D/Output/</span></code>). The output files will be in three formats:
<a class="reference external" href="https://www.mcs.anl.gov/petsc/">PETSc</a>, Matlab and ASCII. Therefore, the
<code class="docutils literal"><span class="pre">Output</span></code> directory will contain three subdirectories: <code class="docutils literal"><span class="pre">Ascii</span></code>, <code class="docutils literal"><span class="pre">Matlab</span></code>
and <code class="docutils literal"><span class="pre">Petsc</span></code>. By default, and for each format, PETGEM save the electric
field responses in different files:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">Ep.xx</span></code>: primary electric field components</li>
<li><code class="docutils literal"><span class="pre">Es.xx</span></code>: secondary electric field components</li>
<li><code class="docutils literal"><span class="pre">Et.xx</span></code>: total electric field components</li>
</ul>
<p>where <code class="docutils literal"><span class="pre">.xx</span></code> is the file extension that depends of the format file.</p>
</div>
<div class="section" id="petgem-post-processing">
<h4><a class="toc-backref" href="#table-of-contents">PETGEM post-processing</a><a class="headerlink" href="#petgem-post-processing" title="Permalink to this headline">¶</a></h4>
<p>Once a solution of a 3D CSEM survey has been obtained, it should be
post-processed by using a visualization program. PETGEM does not do the
visualization by itself, but it generates output files (ASCII,
<a class="reference external" href="https://www.mcs.anl.gov/petsc/">PTSc</a> and Matlab formats are supported)
with the electric responses at receivers positions. It also gives timing values
in order to evaluate the performance.</p>
<p>The <code class="docutils literal"><span class="pre">Ep.xx</span></code>, <code class="docutils literal"><span class="pre">Es.xx</span></code> and <code class="docutils literal"><span class="pre">Et.xx</span></code> fields can be handled freely and plotted. The
dimension of arrays <code class="docutils literal"><span class="pre">Ep.xx</span></code>, <code class="docutils literal"><span class="pre">Es.xx</span></code> and <code class="docutils literal"><span class="pre">Et.xx</span></code> is determined by the
number of receivers in the modelling (58 in this example). <a class="reference internal" href="#figure-7-9">Figure 7.9</a> shows
a comparison of the x-component of total electric field between PETGEM results
and the quasi-analytical solution obtained with the
<a class="reference external" href="http://marineemlab.ucsd.edu/~kkey/pubs/2009b.pdf">DIPOLE1D</a> tool. The total
electric field in <a class="reference internal" href="#figure-7-9">Figure 7.9</a> was calculated using a
mesh with <img class="math" src="_images/math/eeb09f98a36d7f95bf06fa6b39ec78f9718c39ed.png" alt="\approx2"/> millions of DOFs.</p>
<div class="figure align-center" id="id23">
<span id="figure-7-9"></span><a class="reference internal image-reference" href="_images/total_field_X_model1.png"><img alt="In-line canonical off-shore hydrocarbon model with its unstructured tetrahedral mesh for :math:`y&gt;150`" src="_images/total_field_X_model1.png" style="width: 727.5px; height: 369.0px;" /></a>
<p class="caption"><span class="caption-text">Figure 7.9. Total electric field comparative for x-component between PETGEM V1.0 and DIPOLE1D.</span></p>
</div>
</div>
</div>
<div class="section" id="example-3-use-of-petsc-solvers">
<h3><a class="toc-backref" href="#table-of-contents">Example 3: Use of PETSc solvers</a><a class="headerlink" href="#example-3-use-of-petsc-solvers" title="Permalink to this headline">¶</a></h3>
<p>In PETGEM, options for <a class="reference external" href="https://www.mcs.anl.gov/petsc/">PETSc</a> solvers/preconditioners
are accessible via the <code class="docutils literal"><span class="pre">petsc.opts</span></code> file. Here is presented a short list of
relevant configuration options for the solution of the problem under
consideration.</p>
<ul>
<li><p class="first">Direct solver by <a class="reference external" href="http://mumps.enseeiht.fr/">MUMPs</a> via <a class="reference external" href="https://www.mcs.anl.gov/petsc/">PETSc</a> interface</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Solver options for PETSc</span>
<span class="o">-</span><span class="n">pc_type</span> <span class="n">lu</span>
<span class="o">-</span><span class="n">pc_factor_mat_solver_package</span> <span class="n">mumps</span>
</pre></div>
</div>
</li>
<li><p class="first">Generalized minimal residual (GMRES) solver with a successive over-relaxation method (SOR) as preconditioner. Further, these options prints useful information: True residual norm, the preconditioned residual norm at each iteration and reason a iterative method was said to have converged or diverged.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Solver options for PETSc</span>
<span class="o">-</span><span class="n">ksp_type</span> <span class="n">gmres</span>
<span class="o">-</span><span class="n">pc_type</span> <span class="n">sor</span>
<span class="o">-</span><span class="n">ksp_rtol</span> <span class="mf">1e-8</span>
<span class="o">-</span><span class="n">ksp_monitor_true_residual</span>
<span class="o">-</span><span class="n">ksp_converged_reason</span>
</pre></div>
</div>
</li>
<li><p class="first">Generalized minimal residual (GMRES) solver with a geometric algebraic multigrid method (GAMG) as preconditioner.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Solver options for PETSc</span>
<span class="o">-</span><span class="n">ksp_type</span> <span class="n">gmres</span>
<span class="o">-</span><span class="n">pc_type</span> <span class="n">gamg</span>
<span class="o">-</span><span class="n">ksp_rtol</span> <span class="mf">1e-8</span>
</pre></div>
</div>
</li>
<li><p class="first">Generalized minimal residual (GMRES) solver with an additive Schwarz method (ASM) as preconditioner.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Solver options for PETSc</span>
<span class="o">-</span><span class="n">ksp_type</span> <span class="n">gmres</span>
<span class="o">-</span><span class="n">pc_type</span> <span class="n">asm</span>
<span class="o">-</span><span class="n">sub_pc_type</span> <span class="n">lu</span>
<span class="o">-</span><span class="n">ksp_rtol</span> <span class="mf">1e-8</span>
</pre></div>
</div>
</li>
<li><p class="first">Generalized minimal residual (GMRES) solver with a Jacobi method as preconditioner.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Solver options for PETSc</span>
<span class="o">-</span><span class="n">ksp_type</span> <span class="n">gmres</span>
<span class="o">-</span><span class="n">pc_type</span> <span class="n">bjacobi</span>
<span class="o">-</span><span class="n">ksp_rtol</span> <span class="mf">1e-8</span>
</pre></div>
</div>
</li>
<li><p class="first">Transpose free quasi-minimal residual (TFQMR) solver with a successive over-relaxation method (SOR) as preconditioner.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Solver options for PETSc</span>
<span class="o">-</span><span class="n">ksp_type</span> <span class="n">tfqmr</span>
<span class="o">-</span><span class="n">pc_type</span> <span class="n">sor</span>
<span class="o">-</span><span class="n">ksp_rtol</span> <span class="mf">1e-8</span>
</pre></div>
</div>
</li>
</ul>
<p>Previous configuration are based on most used in the literature.</p>
</div>
</div>
<div class="section" id="code-documentation">
<span id="id10"></span><h2><a class="toc-backref" href="#table-of-contents">Code documentation</a><a class="headerlink" href="#code-documentation" title="Permalink to this headline">¶</a></h2>
<p>Following sub-sections are dedicated to code documentation of PETGEM.</p>
<div class="section" id="setup-install-scripts">
<h3><a class="toc-backref" href="#table-of-contents">Setup &amp; install scripts</a><a class="headerlink" href="#setup-install-scripts" title="Permalink to this headline">¶</a></h3>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="setup/setup.html">setup.py</a></li>
</ul>
</div>
</div>
<div class="section" id="kernel">
<h3><a class="toc-backref" href="#table-of-contents">kernel</a><a class="headerlink" href="#kernel" title="Permalink to this headline">¶</a></h3>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="petgem/kernel/kernel.html">kernel.py</a></li>
</ul>
</div>
</div>
<div class="section" id="base-scripts">
<h3><a class="toc-backref" href="#table-of-contents">Base scripts</a><a class="headerlink" href="#base-scripts" title="Permalink to this headline">¶</a></h3>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="petgem/base/basis_scripts.html">base.py</a></li>
<li class="toctree-l1"><a class="reference internal" href="petgem/base/styles.html">styles.py</a></li>
<li class="toctree-l1"><a class="reference internal" href="petgem/base/modelling.html">modelling.py</a></li>
</ul>
</div>
</div>
<div class="section" id="id11">
<h3><a class="toc-backref" href="#table-of-contents">Pre-processing</a><a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h3>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="petgem/preprocessing/preprocessing.html">preprocessing.py</a></li>
</ul>
</div>
</div>
<div class="section" id="mesh-scripts">
<h3><a class="toc-backref" href="#table-of-contents">Mesh scripts</a><a class="headerlink" href="#mesh-scripts" title="Permalink to this headline">¶</a></h3>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="petgem/mesh/mesh.html">mesh.py</a></li>
</ul>
</div>
</div>
<div class="section" id="efem-scripts">
<h3><a class="toc-backref" href="#table-of-contents">EFEM scripts</a><a class="headerlink" href="#efem-scripts" title="Permalink to this headline">¶</a></h3>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="petgem/efem/efem.html">efem.py</a></li>
<li class="toctree-l1"><a class="reference internal" href="petgem/efem/fem.html">fem.py</a></li>
<li class="toctree-l1"><a class="reference internal" href="petgem/efem/vectorMatrixFunctions.html">vectorMatrixFunctions.py</a></li>
</ul>
</div>
</div>
<div class="section" id="solver">
<h3><a class="toc-backref" href="#table-of-contents">Solver</a><a class="headerlink" href="#solver" title="Permalink to this headline">¶</a></h3>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="petgem/solver/assembler.html">assembler.py</a></li>
<li class="toctree-l1"><a class="reference internal" href="petgem/solver/solver.html">solver.py</a></li>
</ul>
</div>
</div>
<div class="section" id="parallel">
<h3><a class="toc-backref" href="#table-of-contents">Parallel</a><a class="headerlink" href="#parallel" title="Permalink to this headline">¶</a></h3>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="petgem/parallel/parallel.html">parallel.py</a></li>
</ul>
</div>
</div>
<div class="section" id="post-processing">
<h3><a class="toc-backref" href="#table-of-contents">Post-processing</a><a class="headerlink" href="#post-processing" title="Permalink to this headline">¶</a></h3>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="petgem/postprocessing/postprocessing.html">postprocessing.py</a></li>
</ul>
</div>
</div>
<div class="section" id="monitoring">
<h3><a class="toc-backref" href="#table-of-contents">Monitoring</a><a class="headerlink" href="#monitoring" title="Permalink to this headline">¶</a></h3>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="petgem/monitoring/monitoring.html">monitoring.py</a></li>
</ul>
</div>
</div>
<div class="section" id="id12">
<h3><a class="toc-backref" href="#table-of-contents">Examples</a><a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="examples/preprocessingParams.html">preprocessingParams.py</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples/modelParams.html">modelParams.py</a></li>
</ul>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="setup/setup.html" title="setup.py"
             >next</a> |</li>
        <li class="right" >
          <a href="Tutorial.html" title="Tutorial"
             >previous</a> |</li>
        <li><a href="index.html">Home</a>|&nbsp;</li>
        <li><a href="WhatIs.html">What is PETGEM?</a>|&nbsp;</li>
        <li><a href="Features.html">Features</a>|&nbsp;</li>
        <li><a href="CSEMEdges.html">CSEM FM modelling</a>|&nbsp;</li>
        <li><a href="Installation.html">Installation</a>|&nbsp;</li>
        <li><a href="Tutorial.html">Tutorial</a>|&nbsp;</li>
        <li><a href="#">Manual</a>|&nbsp;</li>
        <li><a href="Publications.html">Publications</a>|&nbsp;</li>
	      <li><a href="Download.html">Download</a>|&nbsp;</li>
        <li><a href="Contact.html">Contact</a></li>
 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Octavio Castillo Reyes.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.6.
    </div>
  </body>
</html>